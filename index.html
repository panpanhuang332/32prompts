<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ICS Repair Pro - Font Matcher</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .nav-active { @apply text-indigo-600 font-black; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .app-card { border-radius: 32px; }
        canvas { max-width: 100%; height: auto; cursor: crosshair; touch-action: none; background: #eee; }
        .tool-label { @apply text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block; }
    </style>
</head>
<body class="p-4 bg-slate-100 dark:bg-slate-900 min-h-screen pb-28">

    <div class="w-full max-w-md mx-auto bg-white dark:bg-slate-800 app-card shadow-2xl overflow-hidden">
        <div id="repairTab" class="tab-content active">
            <div class="p-6 bg-slate-800 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-black italic text-indigo-400">FONT MATCHER</h1>
                    <p class="text-[9px] opacity-50 tracking-tighter">V5.2 精準字體匹配模式</p>
                </div>
                <button onclick="location.reload()" class="text-xs bg-white/10 p-2 rounded-lg">重置</button>
            </div>
            
            <div class="p-5 space-y-4">
                <div id="editorArea" class="hidden space-y-4 animate-in fade-in">
                    <div class="rounded-2xl overflow-hidden border border-gray-200 dark:border-slate-700 shadow-inner">
                        <canvas id="mainCanvas"></canvas>
                    </div>

                    <div class="grid grid-cols-2 gap-3 p-4 bg-gray-50 dark:bg-slate-900 rounded-2xl">
                        <div>
                            <label class="tool-label">字體選擇</label>
                            <select id="fontFamily" class="w-full text-xs p-2 rounded-lg bg-white border border-gray-200 outline-none">
                                <option value="sans-serif">標準黑體 (推薦)</option>
                                <option value="serif">經典宋體</option>
                                <option value="'Microsoft JhengHei', sans-serif">微軟正黑</option>
                                <option value="cursive">手寫風格</option>
                            </select>
                        </div>
                        <div>
                            <label class="tool-label">文字顏色</label>
                            <div class="flex items-center gap-2">
                                <input type="color" id="textColor" value="#333333" class="w-full h-8 rounded cursor-pointer">
                            </div>
                        </div>
                        <div class="col-span-2">
                            <label class="tool-label">字體大小: <span id="sizeVal">28</span>px</label>
                            <input type="range" id="fontSize" min="10" max="100" value="28" oninput="document.getElementById('sizeVal').innerText=this.value" class="w-full h-2 bg-gray-200 rounded-lg appearance-none">
                        </div>
                    </div>
                    
                    <button onclick="downloadImage()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-check-circle"></i> 完成並下載修復圖
                    </button>
                </div>

                <div id="uploadArea" class="border-2 border-dashed border-slate-200 rounded-3xl p-12 text-center" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-magic text-4xl text-indigo-500 mb-4"></i>
                    <p class="text-sm font-bold text-gray-500">上傳 NotebookLM 圖片</p>
                    <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="loadImage(this)">
                </div>
            </div>
        </div>
    </div>

    <div id="textOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] hidden items-center justify-center p-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs space-y-4">
            <h3 class="font-black text-gray-800">請輸入正確的字</h3>
            <input type="text" id="correctText" class="w-full p-4 bg-gray-100 rounded-xl text-xl text-center font-bold outline-none" placeholder="輸入文字" autofocus>
            <div class="flex gap-2">
                <button onclick="applyText()" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-bold">立即修復</button>
                <button onclick="closeOverlay()" class="flex-1 bg-gray-200 text-gray-500 py-4 rounded-xl font-bold">取消</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let currentX, currentY, bgImg;

        function loadImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    bgImg = new Image();
                    bgImg.onload = () => {
                        canvas.width = bgImg.width;
                        canvas.height = bgImg.height;
                        ctx.drawImage(bgImg, 0, 0);
                        document.getElementById('editorArea').classList.remove('hidden');
                        document.getElementById('uploadArea').classList.add('hidden');
                    };
                    bgImg.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            currentX = (e.clientX - rect.left) * scaleX;
            currentY = (e.clientY - rect.top) * scaleY;

            // 自動採樣文字顏色（這能讓新字顏色更準確）
            const pixel = ctx.getImageData(currentX, currentY, 1, 1).data;
            // 如果點擊的地方太亮，就不更新顏色，避免吸到背景色
            if (pixel[0] < 200) {
                document.getElementById('textColor').value = rgbToHex(pixel[0], pixel[1], pixel[2]);
            }

            document.getElementById('textOverlay').classList.remove('hidden');
            document.getElementById('textOverlay').classList.add('flex');
            document.getElementById('correctText').focus();
        });

        function applyText() {
            const text = document.getElementById('correctText').value;
            const fontSize = document.getElementById('fontSize').value;
            const fontFamily = document.getElementById('fontFamily').value;
            const textColor = document.getElementById('textColor').value;
            if (!text) return;

            // 1. 採樣背景顏色（往旁邊偏移一點點去採樣背景）
            const bgPixel = ctx.getImageData(currentX - fontSize, currentY, 1, 1).data;
            const bgColor = `rgb(${bgPixel[0]}, ${bgPixel[1]}, ${bgPixel[2]})`;

            // 2. 塗掉損壞區域
            const boxSize = fontSize * 1.6;
            ctx.fillStyle = bgColor;
            ctx.fillRect(currentX - boxSize/2, currentY - boxSize/2, boxSize, boxSize);

            // 3. 繪製新文字
            ctx.fillStyle = textColor;
            ctx.font = `bold ${fontSize}px ${fontFamily}`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(text, currentX, currentY);

            closeOverlay();
            document.getElementById('correctText').value = '';
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function closeOverlay() {
            document.getElementById('textOverlay').classList.remove('flex');
            document.getElementById('textOverlay').classList.add('hidden');
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'repaired_notebooklm.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
