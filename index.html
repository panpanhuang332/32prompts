<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸€æŒ‡æç¤º (UIä¿®å¾©ç‰ˆ)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // --- æ¸…é™¤å¿«å–ç¢ºä¿ UI æ›´æ–° ---
        if ('serviceWorker' in navigator) {
            caches.keys().then(names => {
                for (let name of names) caches.delete(name);
            });
        }
    </script>

    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        :root {
            --bg-deep: #050505;
            --glass-border: rgba(255, 255, 255, 0.12);
            --text-main: #E0E0E0;
            --accent-glow: #3b82f6;
        }
        body {
            background-color: var(--bg-deep); color: var(--text-main); font-family: 'Noto Sans TC', sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 60%);
        }

        /* --- é ‚éƒ¨å°èˆª --- */
        .app-header {
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 15px 15px 5px 15px; border-bottom: 1px solid rgba(255,255,255,0.08); z-index: 100; flex-shrink: 0;
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-title { 
            margin: 0; font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1.1rem; letter-spacing: 1px;
            background: linear-gradient(90deg, #fff, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .btn-google-login {
            font-size: 0.8rem; padding: 6px 14px; border-radius: 50px; background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
            border: 1px solid var(--glass-border); color: #ccc; display: flex; align-items: center; gap: 8px; transition: all 0.3s;
        }
        .user-info { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #bbb; cursor: pointer; }
        .user-avatar { width: 30px; height: 30px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); }

        /* --- è¼¸å…¥å€èˆ‡æŒ‰éˆ• --- */
        .form-control, .form-select {
            background-color: #111; border: 1px solid #333; color: #fff; border-radius: 12px; padding: 12px; font-size: 0.95rem;
        }
        .form-control:focus, .form-select:focus { background-color: #000; border-color: #666; color: #fff; box-shadow: none; }
        
        .mode-switch-container { display: flex; gap: 8px; margin-bottom: 15px; background: rgba(255,255,255,0.03); padding: 4px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .mode-btn { flex: 1; border: none; background: transparent; padding: 8px; font-size: 0.85rem; border-radius: 8px; color: #666; font-weight: 500; transition: all 0.3s; }
        .mode-btn.active { background: linear-gradient(145deg, #222, #111); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .mode-btn.mode-reverse.active { color: #d1c4e9; border: 1px solid rgba(171, 71, 188, 0.3); background: linear-gradient(145deg, #2a0a2e, #1a051d); }

        .action-bar { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-action { flex: 1; border: none; border-radius: 12px; padding: 10px; font-size: 0.9rem; font-weight: 500; color: #fff; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-upload { background: linear-gradient(135deg, #b71c1c 0%, #7f0000 100%); border: 1px solid #e53935; }
        .btn-random { background: linear-gradient(135deg, #f57f17 0%, #e65100 100%); border: 1px solid #ffb300; }
        .btn-translate { background: #222; color: #bbb; border: 1px solid #444; border-radius: 0 12px 12px 0; }

        /* --- æ¨™ç±¤é  (Tabs) --- */
        .nav-tabs { border: none; gap: 8px; padding-bottom: 10px; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .nav-link { border: 1px solid transparent; border-radius: 20px; background: rgba(255,255,255,0.05); color: #888; font-size: 0.85rem; padding: 6px 14px; white-space: nowrap; transition: all 0.2s; }
        .nav-link.active { background: #fff; color: #000; font-weight: 700; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .nav-link.disabled-tab { opacity: 0.4; cursor: not-allowed; background: #111; border: 1px solid #333; color: #555; }

        /* --- å…§å®¹å€ (é—œéµä¿®å¾©ï¼šé è¨­éš±è—) --- */
        .app-content { flex-grow: 1; overflow-y: auto; padding: 10px 15px 80px 15px; } /* å¢åŠ åº•éƒ¨ padding é¿å…è¢«æŒ‰éˆ•æ“‹ä½ */
        
        /* âš ï¸ é€™è£¡æ˜¯é—œéµä¿®å¾©ï¼åŸæœ¬å°‘äº† display: none å°è‡´å…¨éƒ¨ç–Šåœ¨ä¸€èµ· */
        .tab-content-area { display: none; animation: fadeIn 0.3s ease; }
        .tab-content-area.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .category-card { background: linear-gradient(145deg, #111, #080808); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); border-top: 1px solid rgba(255,255,255,0.15); }
        .category-title { font-size: 0.95rem; color: #fff; margin-bottom: 10px; border-left: 3px solid var(--accent-glow); padding-left: 10px; display: block; }

        /* --- åº•éƒ¨èˆ‡å…¶ä»– --- */
        .app-footer { background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(15px); padding: 15px 20px 25px 20px; border-top: 1px solid rgba(255,255,255,0.1); position: fixed; bottom: 0; left: 0; right: 0; z-index: 200; }
        #generateBtn { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; padding: 12px; font-size: 1.1rem; color: white; width: 100%; font-weight: 700; }
        #outputPrompt { background-color: #000; color: #00ff9d; border: 1px solid #333; font-family: monospace; font-size: 0.85rem; }

        .camera-preview-box { width: 60px; height: 60px; border-radius: 10px; border: 1px solid #555; overflow: hidden; display: none; margin-right: 10px; position: relative; }
        .btn-clear-img { background: rgba(0,0,0,0.7); color: #fff; position: absolute; top: 0; right: 0; width: 100%; height: 100%; border: none; opacity: 0; }
        .camera-preview-box:hover .btn-clear-img { opacity: 1; }
        
        .limit-badge { color: #ff5252; font-size: 0.7em; margin-left: 3px; font-weight: 800; vertical-align: text-top; }
        .locked-badge { display: none; font-size: 0.7rem; background: #333; color: #aaa; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .loading-text { color: var(--accent-glow); font-size: 0.8rem; margin-top: 5px; display: none; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="top-bar">
            <h6 class="app-title">âœ¨ ä¸€æŒ‡æç¤º <span style="font-size:0.7em; opacity:0.7;">PRO</span></h6>
            <button id="loginBtn" class="btn-google-login" onclick="googleLogin()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="16" alt="G"> ç™»å…¥
            </button>
            <div id="userInfo" class="user-info" style="display: none;" onclick="googleLogout()">
                <img id="userPhoto" src="" class="user-avatar">
                <span id="userName">User</span>
            </div>
        </div>
        
        <div class="mode-switch-container">
            <button class="mode-btn active" onclick="setMode('create')" id="mode-create">ğŸ¨ ç¹ªåœ–æŒ‡ä»¤</button>
            <button class="mode-btn mode-reverse" onclick="setMode('reverse')" id="mode-reverse">ğŸ”® åæ¨æç¤ºè©</button>
        </div>

        <div class="mb-2">
            <div class="d-flex align-items-center mb-2" id="inputRow">
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleImageSelect(this)">
                <div id="previewBox" class="camera-preview-box">
                    <img id="finalImage" class="captured-image" style="width:100%;height:100%;object-fit:cover;">
                    <button class="btn-clear-img" onclick="clearPhoto()">âœ•</button>
                </div>
                <div class="input-group">
                    <input type="text" class="form-control border-end-0" id="mainSubject" placeholder="è¼¸å…¥å…§å®¹ (å¦‚: è²“)..." style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                    <button class="btn btn-translate" type="button" id="translateBtn" onclick="translateInput()">ä¸­ç¿»è‹±</button>
                </div>
            </div>
            
            <div class="action-bar">
                <button class="btn-action btn-upload" type="button" onclick="triggerNativeCamera()">ğŸ“¸ ä¸Šå‚³åƒè€ƒåœ–</button>
                <button class="btn-action btn-random" id="btnRandom" type="button" onclick="autoRandomize()">ğŸ² éš¨æ©Ÿéˆæ„Ÿ</button>
            </div>
            <div id="translationStatus" class="loading-text">âœ¨ AI æ­£åœ¨ç¿»è­¯ä¸­...</div>
        </div>

        <div class="nav nav-tabs" id="myTab" role="tablist">
            <button class="nav-link active" onclick="switchTab(this, 'page-settings')">âš™ï¸ è¨­å®š</button>
            <button class="nav-link" onclick="switchTab(this, 'page-text')">ğŸ”¤ æ–‡å­—</button>
            <button class="nav-link" onclick="switchTab(this, 'page-char')">ğŸ‘¤ äººç‰©</button>
            <button class="nav-link" onclick="switchTab(this, 'page-scene')">ğŸï¸ å ´æ™¯</button>
            <button class="nav-link disabled-tab" id="btn-photo" onclick="switchTab(this, 'page-photo')">ğŸ“¸ æ”å½± <span class="limit-badge">é™</span></button>
            <button class="nav-link disabled-tab" id="btn-art" onclick="switchTab(this, 'page-art')">ğŸ–Œï¸ è—è¡“ <span class="limit-badge">é™</span> <span class="locked-badge">é–</span></button>
            <button class="nav-link disabled-tab" id="btn-anime" onclick="switchTab(this, 'page-anime')">ğŸ§¸ å‹•æ¼« <span class="limit-badge">é™</span> <span class="locked-badge">é–</span></button>
        </div>
    </div>

    <div class="app-content">
        <div id="mode-hint" class="mb-3"></div>

        <div id="page-settings" class="tab-content-area active">
            <div class="category-card">
                <label class="category-title">ğŸ“ åœ–ç‰‡æ¯”ä¾‹ (Aspect Ratio)</label>
                <select class="form-select" id="aspectRatio">
                    <option value="" selected>1:1 (é è¨­æ­£æ–¹å½¢)</option>
                    <optgroup label="æ©«å‘ (Landscape)">
                        <option value="--ar 16:9">16:9 (å¯¬è¢å¹•/YT)</option>
                        <option value="--ar 21:9">21:9 (é›»å½±æ„Ÿ)</option>
                        <option value="--ar 4:3">4:3 (æ¨™æº–ç…§ç‰‡)</option>
                    </optgroup>
                    <optgroup label="ç›´å‘ (Portrait)">
                        <option value="--ar 4:5">4:5 (IG è²¼æ–‡)</option>
                        <option value="--ar 3:4">3:4 (ç›´å¼ç…§ç‰‡)</option>
                        <option value="--ar 9:16">9:16 (é™å‹•/Reels)</option>
                    </optgroup>
                </select>
            </div>
            <div class="category-card">
                <label class="category-title">ğŸ’ ç•«è³ªèˆ‡ç´°ç¯€</label>
                <select class="form-select" id="pixelResolution">
                    <option value="" selected>é è¨­</option>
                    <option value="high quality, 4k">4K é«˜ç•«è³ª</option>
                    <option value="8k resolution, highly detailed">8K è¶…ç²¾ç´°</option>
                    <option value="masterpiece, best quality">å¤§å¸«ç´šå‚‘ä½œ</option>
                    <option value="photorealistic, ultra realistic">è¶…å¯«å¯¦ç…§ç‰‡ç´š</option>
                </select>
            </div>
        </div>

        <div id="page-text" class="tab-content-area">
            <div class="category-card">
                <label class="category-title">ğŸ”¤ æ’å…¥æ–‡å­—</label>
                <div class="mb-3">
                    <label class="form-label text-light small">æ–‡å­—å…§å®¹</label>
                    <input type="text" class="form-control" id="textContent" placeholder="ä¾‹å¦‚: Hello World">
                </div>
                <div class="mb-3">
                    <label class="form-label text-light small">ä½ç½®èªªæ˜</label>
                    <input type="text" class="form-control" id="textPosition" placeholder="ä¾‹å¦‚: written on a neon sign">
                </div>
                 <div class="mb-3">
                    <label class="form-label text-light small">å­—é«”é¢¨æ ¼</label>
                    <select class="form-select" id="textFont"></select>
                </div>
            </div>
        </div>

        <div id="page-char" class="tab-content-area"><div id="container-char"></div></div>
        <div id="page-scene" class="tab-content-area"><div id="container-scene"></div></div>
        <div id="page-photo" class="tab-content-area"><div id="container-photo"></div></div>
        <div id="page-art" class="tab-content-area"><div id="container-art"></div></div>
        <div id="page-anime" class="tab-content-area"><div id="container-anime"></div></div>
    </div>

    <div class="app-footer">
        <div class="d-grid gap-2 mb-2">
            <button class="btn btn-primary fw-bold" id="generateBtn" onclick="generatePrompt()">
                âœ¨ ç”¢å‡ºæŒ‡ä»¤
            </button>
        </div>
        <div class="input-group input-group-sm">
            <textarea class="form-control" id="outputPrompt" rows="3" readonly placeholder="æç¤ºè©å°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard()" style="background: #222; color: #fff; border: 1px solid #444;">è¤‡è£½</button>
        </div>
    </div>

<script>
    // ==========================================
    // âš ï¸ è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Firebase Config âš ï¸
    // ==========================================
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    let isLoggedIn = false;
    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error("Firebase Init Error", e); }

    function googleLogin() {
        if (!firebase.apps.length) return alert("è«‹å…ˆå¡«å…¥ Firebase Config ä»£ç¢¼ï¼");
        const provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider).catch((error) => alert("ç™»å…¥å¤±æ•—: " + error.message));
    }

    function googleLogout() { if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) firebase.auth().signOut(); }

    if (firebase.apps.length) {
        firebase.auth().onAuthStateChanged((user) => {
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            const restrictedTabs = ['btn-photo', 'btn-art', 'btn-anime'];

            if (user) {
                isLoggedIn = true;
                loginBtn.style.display = 'none';
                userInfo.style.display = 'flex';
                document.getElementById('userPhoto').src = user.photoURL;
                document.getElementById('userName').textContent = user.displayName;

                restrictedTabs.forEach(id => {
                    const btn = document.getElementById(id);
                    btn.classList.remove('disabled-tab');
                    const limitBadge = btn.querySelector('.limit-badge');
                    if (limitBadge) limitBadge.style.display = 'none';
                });
                
                checkLocks();
            } else {
                isLoggedIn = false;
                loginBtn.style.display = 'flex';
                userInfo.style.display = 'none';
                restrictedTabs.forEach(id => {
                    const btn = document.getElementById(id);
                    btn.classList.add('disabled-tab');
                    const limitBadge = btn.querySelector('.limit-badge');
                    if (limitBadge) limitBadge.style.display = 'inline';
                });
                // å¦‚æœç›®å‰åœ¨é™åˆ¶é é¢ï¼Œè·³å›è¨­å®šé 
                const activeTab = document.querySelector('.nav-link.active');
                if (restrictedTabs.includes(activeTab.id)) switchTab(document.querySelector('.nav-link'), 'page-settings');
            }
        });
    }

    let currentMode = 'create';
    const fontData = [{val: "Bold sans-serif", label: "ç²—é«”ç„¡è¥¯ç·š"}, {val: "Elegant serif", label: "å„ªé›…è¥¯ç·š"}, {val: "Handwritten script", label: "æ‰‹å¯«è‰æ›¸"}, {val: "Cyberpunk neon style", label: "è³½åšé¾å…‹éœ“è™¹"}, {val: "Vintage retro style", label: "å¾©å¤é¢¨æ ¼"}, {val: "Graffiti style", label: "å¡—é´‰é¢¨æ ¼"}, {val: "Calligraphy brush stroke", label: "æ›¸æ³•æ¯›ç­†"}, {val: "Pixel art style", label: "åƒç´ é¢¨æ ¼"}];

    // è³‡æ–™çµæ§‹ï¼šä¿®æ­£åˆ†é¡é‚è¼¯
    const categorizedData = {
        "char": { 
            "æœè£": [{val: "T-shirt and jeans", label: "Tæ¤ç‰›ä»”è¤²"}, {val: "Suit", label: "è¥¿è£"}, {val: "Evening gown", label: "æ™šç¦®æœ"}, {val: "Cyberpunk techwear", label: "æ©Ÿèƒ½é¢¨"}, {val: "Kimono", label: "å’Œæœ"}, {val: "School uniform", label: "åˆ¶æœ"}, {val: "Maid outfit", label: "å¥³åƒ•è£"}, {val: "Sportswear", label: "é‹å‹•æœ"}],
            "é«®å‹": [{val: "Long straight black hair", label: "é»‘é•·ç›´"}, {val: "Short bob cut", label: "é®‘ä¼¯é ­"}, {val: "Blonde ponytail", label: "é‡‘é«®é¦¬å°¾"}, {val: "Silver twin tails", label: "éŠ€é«®é›™é¦¬å°¾"}, {val: "Pink hair", label: "ç²‰é«®"}, {val: "Bald", label: "å…‰é ­"}],
            "äº”å®˜": [{val: "Blue eyes", label: "è—çœ¼"}, {val: "Red eyes", label: "ç´…çœ¼"}, {val: "Heterochromia", label: "ç•°è‰²ç³"}, {val: "Cat eyes", label: "è²“çœ¼"}, {val: "Wearing glasses", label: "çœ¼é¡"}, {val: "Freckles", label: "é›€æ–‘"}],
            "è¡¨æƒ…": [{val: "Smile", label: "å¾®ç¬‘"}, {val: "Laughing", label: "å¤§ç¬‘"}, {val: "Crying", label: "å“­æ³£"}, {val: "Angry", label: "ç”Ÿæ°£"}, {val: "Seductive", label: "èª˜æƒ‘"}, {val: "Surprised", label: "é©šè¨"}],
            "å‹•ä½œ": [{val: "Standing", label: "ç«™ç«‹"}, {val: "Sitting", label: "åè‘—"}, {val: "Running", label: "å¥”è·‘"}, {val: "Fighting stance", label: "æˆ°é¬¥å§¿å‹¢"}, {val: "Peace sign", label: "æ¯”YA"}, {val: "Looking back", label: "å›çœ¸"}]
        },
        "scene": { 
            "ç’°å¢ƒ": [{val: "Indoor", label: "å®¤å…§"}, {val: "Outdoor", label: "å®¤å¤–"}, {val: "Forest", label: "æ£®æ—"}, {val: "Underwater", label: "æµ·åº•"}, {val: "Outer Space", label: "å¤ªç©º"}, {val: "Cyberpunk City", label: "è³½åšåŸå¸‚"}],
            "åœ°é»": [{val: "Bedroom", label: "è‡¥å®¤"}, {val: "Classroom", label: "æ•™å®¤"}, {val: "Rooftop", label: "å¤©å°"}, {val: "Street", label: "è¡—é“"}, {val: "Beach", label: "æµ·ç˜"}, {val: "Cafe", label: "å’–å•¡å»³"}],
            "å…‰ç·š": [{val: "Daylight", label: "æ—¥å…‰"}, {val: "Night", label: "å¤œæ™š"}, {val: "Sunset", label: "æ—¥è½"}, {val: "Cinematic lighting", label: "é›»å½±å…‰"}, {val: "Neon lights", label: "éœ“è™¹ç‡ˆ"}]
        },
        "photo": { 
            "é¡å‹ (Type)": [{id: "photo_type", val: "photo", label: "ä¸€èˆ¬ç…§ç‰‡"}, {id: "photo_type", val: "portrait photography", label: "äººåƒæ”å½±"}, {id: "photo_type", val: "street photography", label: "è¡—é ­æ”å½±"}, {id: "photo_type", val: "macro photography", label: "å¾®è·æ”å½±"}],
            "é¡é ­ (Lens)": [{id:"photo_focal", val:"20mm", label:"20mm è¶…å»£è§’"}, {id:"photo_focal", val:"35mm", label:"35mm äººæ–‡"}, {id:"photo_focal", val:"85mm", label:"85mm äººåƒ"}, {id:"photo_focal", val:"200mm", label:"200mm æœ›é "}],
            "å…‰åœˆ (Aperture)": [{id:"photo_aperture", val:"f/1.4", label:"f/1.4 (å¤§å…‰åœˆè™›åŒ–)"}, {id:"photo_aperture", val:"f/2.8", label:"f/2.8"}, {id:"photo_aperture", val:"f/8", label:"f/8 (é¢¨æ™¯æ¸…æ™°)"}, {id:"photo_aperture", val:"f/16", label:"f/16"}],
            "åº•ç‰‡/é¢¨æ ¼": [{val:"Fujifilm color", label:"å¯Œå£«è‰²å½©"}, {val:"Kodak Portra 400", label:"æŸ¯é” Portra"}, {val:"Polaroid", label:"æ‹ç«‹å¾—"}, {val:"Monochrome", label:"é»‘ç™½"}]
        },
        "art": { 
            "åª’æ": [{val:"oil painting", label:"æ²¹ç•«"}, {val:"watercolor", label:"æ°´å½©"}, {val:"sketch", label:"ç´ æ"}, {val:"ink painting", label:"æ°´å¢¨"}, {val:"vector art", label:"å‘é‡åœ–"}, {val:"3D render", label:"3D æ¸²æŸ“"}],
            "æµæ´¾": [{val:"Impressionism", label:"å°è±¡æ´¾"}, {val:"Surrealism", label:"è¶…ç¾å¯¦"}, {val:"Pop Art", label:"æ™®æ™®è—è¡“"}, {val:"Ukiyo-e", label:"æµ®ä¸–ç¹ª"}, {val:"Pixel Art", label:"åƒç´ ç•«"}],
            "è—è¡“å®¶é¢¨æ ¼": [{val:"by Van Gogh", label:"æ¢µè°·"}, {val:"by Makoto Shinkai", label:"æ–°æµ·èª "}, {val:"by Hayao Miyazaki", label:"å®®å´é§¿"}, {val:"by Wes Anderson", label:"é­æ–¯å®‰å¾·æ£®"}]
        },
        "anime": { 
            "é¢¨æ ¼": [{val: "Anime style", label: "é€šç”¨å‹•æ¼«"}, {val: "Ghibli style", label: "å‰åœåŠ›"}, {val: "Makoto Shinkai style", label: "æ–°æµ·èª "}, {val: "Kyoto Animation style", label: "äº¬é˜¿å°¼"}, {val: "90s anime style", label: "90å¹´ä»£å¾©å¤"}],
            "é¡å‹": [{val:"Chibi", label:"Qç‰ˆ"}, {val:"Mecha", label:"æ©Ÿç”²"}, {val:"Magical Girl", label:"é­”æ³•å°‘å¥³"}, {val:"Shonen", label:"å°‘å¹´æ¼«ç•«"}]
        }
    };

    function init() {
        // 1. åˆå§‹åŒ–å­—é«”
        const fontSelect = document.getElementById('textFont');
        fontSelect.innerHTML = "<option value=''>ä¸æŒ‡å®š</option>";
        fontData.forEach(item => fontSelect.appendChild(new Option(item.label, item.val)));

        // 2. åˆå§‹åŒ–å‹•æ…‹å®¹å™¨
        for (const [tabKey, categories] of Object.entries(categorizedData)) {
            const container = document.getElementById(`container-${tabKey}`);
            if (!container) continue;
            
            container.innerHTML = ""; // ç¢ºä¿æ¸…ç©º

            for (const [catName, items] of Object.entries(categories)) {
                const card = document.createElement('div'); 
                card.className = 'category-card';
                
                const label = document.createElement('label'); 
                label.className = 'category-title'; 
                label.textContent = catName;
                card.appendChild(label);
                
                const select = document.createElement('select'); 
                select.className = 'form-select category-select'; 
                // å¦‚æœæ˜¯ç¬¬ä¸€é …ä¸”æœ‰ IDï¼Œè³¦äºˆ ID (ç‚ºäº†æ”å½±é€£å‹•)
                if (items.length > 0 && items[0].id) select.id = items[0].id;
                
                select.appendChild(new Option("ä¸æŒ‡å®š", ""));
                items.forEach(item => select.appendChild(new Option(item.label, item.val)));
                
                card.appendChild(select);
                container.appendChild(card);
            }
        }
        
        // 3. ç¶å®šæ”å½±é€£å‹•é‚è¼¯
        const photoType = document.getElementById('photo_type');
        if (photoType) {
            photoType.addEventListener('change', checkLocks);
        }
        
        // 4. é è¨­é¡¯ç¤ºç¬¬ä¸€é 
        setMode('create');
    }

    function checkLocks() {
        if (!isLoggedIn) return;
        const photoType = document.getElementById('photo_type');
        const isPhoto = photoType && photoType.value !== "";
        
        // é€£å‹•é¡é ­èˆ‡å…‰åœˆ
        ['photo_aperture', 'photo_focal'].forEach(id => {
            const el = document.getElementById(id);
            if(el) { 
                el.disabled = !isPhoto; 
                if(!isPhoto) el.value=""; 
            }
        });

        // é–å®šè¡çªé¸é … (æ”å½±æ¨¡å¼ä¸‹ä¸èƒ½é¸è—è¡“/å‹•æ¼«)
        toggleLock('container-art', 'btn-art', isPhoto);
        toggleLock('container-anime', 'btn-anime', isPhoto);
    }

    function toggleLock(cid, bid, lock) {
        if (!isLoggedIn) return; 
        const c = document.getElementById(cid);
        const b = document.getElementById(bid);
        
        if(c) c.querySelectorAll('select').forEach(s => { s.disabled = lock; if(lock) s.value=""; });
        if(b) {
            b.querySelector('.locked-badge').style.display = lock ? 'inline-block' : 'none';
            b.classList.toggle('disabled-tab', lock);
            // ç§»é™¤ click äº‹ä»¶å¦‚æœæ˜¯ lock ç‹€æ…‹ (é€™è£¡ç°¡åŒ–è™•ç†ï¼Œé€é disabled-tab åˆ¤æ–·)
        }
        if(c) c.querySelectorAll('.category-card').forEach(card => card.style.opacity = lock ? '0.3' : '1');
    }

    function switchTab(btn, targetId) {
        // æª¢æŸ¥æ˜¯å¦ç¦ç”¨
        if (btn.classList.contains('disabled-tab')) {
            const isLimit = btn.querySelector('.limit-badge') && btn.querySelector('.limit-badge').style.display !== 'none';
            const isLocked = btn.querySelector('.locked-badge') && btn.querySelector('.locked-badge').style.display !== 'none';
            
            if (isLimit) {
                alert("ğŸ”’ æœƒå“¡é™å®šåŠŸèƒ½\n\nè«‹é»é¸å³ä¸Šè§’ã€Œç™»å…¥ã€Google å¸³è™Ÿä»¥è§£é–æ­¤åŠŸèƒ½ï¼");
            } else if (isLocked) {
                alert("âš ï¸ æ¨¡å¼è¡çª\n\næ‚¨å·²é¸æ“‡ã€Œæ”å½±é¡å‹ã€ï¼Œå› æ­¤ç„¡æ³•åŒæ™‚é¸æ“‡è—è¡“/å‹•æ¼«é¢¨æ ¼ã€‚\nè«‹å…ˆå°‡æ”å½±é¡å‹è¨­ç‚ºã€Œä¸æŒ‡å®šã€å³å¯è§£é–ã€‚");
            }
            return;
        }

        // UI åˆ‡æ›
        document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // å…§å®¹åˆ‡æ› (é€™è£¡å°±æ˜¯ä½ åŸæœ¬ç¼ºå°‘çš„é‚è¼¯!)
        document.querySelectorAll('.tab-content-area').forEach(div => div.classList.remove('active'));
        document.getElementById(targetId).classList.add('active');
    }

    function setMode(mode) {
        currentMode = mode;
        const els = ['inputRow', 'btnRandom', 'myTab'];
        const isReverse = mode === 'reverse';
        
        document.getElementById('mode-create').classList.toggle('active', !isReverse);
        document.getElementById('mode-reverse').classList.toggle('active', isReverse);
        
        els.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = isReverse ? 'none' : (id === 'inputRow' || id === 'myTab' ? 'flex' : 'block');
        });

        const hint = document.getElementById('mode-hint');
        const genBtn = document.getElementById('generateBtn');
        
        if (isReverse) {
            switchTab(document.querySelectorAll('.nav-link')[0], 'page-settings'); // å¼·åˆ¶å›ç¬¬ä¸€é é¿å…æ®˜ç•™
            document.querySelectorAll('.tab-content-area').forEach(d => d.classList.remove('active')); // éš±è—æ‰€æœ‰é¸å–®
            hint.innerHTML = `<div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; color: #d1c4e9; border: 1px solid rgba(255,255,255,0.1); text-align: center;"><strong>ğŸ”® åæ¨æç¤ºè©æ¨¡å¼</strong><br><br>1. æŒ‰ä¸Šæ–¹ã€ŒğŸ“¸ ä¸Šå‚³åƒè€ƒåœ–ã€<br>2. æŒ‰ä¸‹æ–¹ã€Œç”¢å‡ºæŒ‡ä»¤ã€<br>3. åœ¨ Gemini è²¼ä¸Šä¸¦<b>ä¸Šå‚³åœ–ç‰‡</b></div>`;
            genBtn.textContent = "ğŸ” ç”¢å‡ºåˆ†ææŒ‡ä»¤";
            genBtn.style.background = "linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%)";
        } else {
            hint.innerHTML = "";
            switchTab(document.querySelector('.nav-link.active') || document.querySelectorAll('.nav-link')[0], 'page-settings');
            genBtn.textContent = "âœ¨ ç”¢å‡ºç¹ªåœ–æŒ‡ä»¤";
            genBtn.style.background = "linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)";
        }
    }

    function autoRandomize() {
        if (currentMode === 'reverse') return;
        const activeDiv = document.querySelector('.tab-content-area.active');
        if (!activeDiv) return;

        let changed = false;
        
        // éš¨æ©Ÿé¸å–®
        activeDiv.querySelectorAll('select').forEach(select => {
            if (select.disabled || select.options.length <= 1) return;
            // 30% æ©Ÿç‡ä¸é¸ (ä¿æŒä¸æŒ‡å®š)ï¼Œè®“æç¤ºè©ä¸è¦å¤ªé›œ
            if (Math.random() > 0.3) {
                const idx = Math.floor(Math.random() * (select.options.length - 1)) + 1;
                select.selectedIndex = idx;
                changed = true;
            } else {
                select.selectedIndex = 0;
            }
            select.dispatchEvent(new Event('change'));
        });

        // éš¨æ©Ÿæ–‡å­— (å¦‚æœåœ¨æ–‡å­—é )
        if (activeDiv.id === 'page-text') {
            const texts = ["Hello", "Cyberpunk", "Dream", "Future", "AI Art"];
            document.getElementById('textContent').value = texts[Math.floor(Math.random() * texts.length)];
            changed = true;
        }

        if (changed) {
            generatePrompt();
            const btn = document.getElementById('btnRandom');
            btn.innerHTML = "âœ…";
            setTimeout(() => btn.innerHTML = "ğŸ² éš¨æ©Ÿéˆæ„Ÿ", 800);
        }
    }

    function triggerNativeCamera() { document.getElementById('cameraInput').click(); }
    
    function handleImageSelect(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('finalImage').src = e.target.result;
                document.getElementById('previewBox').style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function clearPhoto() {
        document.getElementById('finalImage').src = "";
        document.getElementById('previewBox').style.display = 'none';
        document.getElementById('cameraInput').value = "";
    }

    async function generatePrompt() {
        const parts = [];
        
        if (currentMode === 'reverse') {
            // åæ¨æ¨¡å¼æŒ‡ä»¤
            if (document.getElementById('finalImage').getAttribute('src') === "") {
                return alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼");
            }
            parts.push("You are an expert Prompt Engineer.");
            parts.push("Please analyze the attached image in extreme detail.");
            parts.push("Provide a high-quality Stable Diffusion text prompt that matches this image.");
            parts.push("Include: Subject, Pose, Outfit, Environment, Lighting, and Art Style.");
        } else {
            // ç¹ªåœ–æ¨¡å¼æŒ‡ä»¤
            let subject = document.getElementById('mainSubject').value.trim();
            const txtContent = document.getElementById('textContent').value.trim();
            const txtPos = document.getElementById('textPosition').value.trim();
            const txtFont = document.getElementById('textFont').value;
            const aspectRatio = document.getElementById('aspectRatio').value;
            
            // ç¿»è­¯
            const btn = document.getElementById('generateBtn');
            if (subject && /[\u4e00-\u9fa5]/.test(subject)) {
                 btn.textContent = "â³ ç¿»è­¯ä¸­...";
                 subject = await translateInput() || subject;
                 btn.textContent = "âœ¨ ç”¢å‡ºç¹ªåœ–æŒ‡ä»¤";
            }

            // çµ„åˆæç¤ºè©
            if (subject) parts.push(`Subject: ${subject},`);
            
            // æ”¶é›†æ‰€æœ‰å·²é¸çš„é¸å–®
            const details = [];
            document.querySelectorAll('select').forEach(s => {
                if(s.value && !s.disabled && s.id !== 'aspectRatio' && s.id !== 'textFont' && s.id !== 'pixelResolution') {
                    details.push(s.value);
                }
            });
            if (details.length > 0) parts.push(details.join(", ") + ",");
            
            // æ–‡å­—
            if (txtContent) {
                parts.push(`Text: "${txtContent}"`);
                if (txtPos) parts.push(`Text Position: ${txtPos}`);
                if (txtFont) parts.push(`Font: ${txtFont}`);
                parts.push(",");
            }

            // ç•«è³ªèˆ‡æ¯”ä¾‹
            const res = document.getElementById('pixelResolution').value;
            if (res) parts.push(res);
            if (aspectRatio) parts.push(aspectRatio);
        }

        document.getElementById('outputPrompt').value = parts.join(" ");
    }

    async function translateInput() {
        const text = document.getElementById('mainSubject').value.trim();
        try {
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh-TW|en`);
            const data = await res.json();
            return data.responseData?.translatedText;
        } catch (e) { return text; }
    }

    function copyToClipboard() {
        const el = document.getElementById("outputPrompt");
        el.select(); navigator.clipboard.writeText(el.value);
    }

    // å•Ÿå‹•
    init();
    if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
</script>
</body>
</html>
