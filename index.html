<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 產圖大師 9527</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">
    <div class="max-w-2xl w-full space-y-8 text-center">
        <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">AI 產圖大師 9527</h1>
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-2xl">
            <textarea id="userInput" rows="4" class="w-full bg-gray-900 p-4 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="輸入描述，例如：科幻風格的台北街頭..."></textarea>
            <button id="generateBtn" class="w-full mt-4 bg-gradient-to-r from-blue-600 to-purple-600 py-3 rounded-lg font-bold hover:scale-105 transition">AI 思考並自動產圖</button>
        </div>
        <div id="statusArea" class="hidden"><p class="text-blue-400 italic loading-dots">Gemini 正在分析需求</p></div>
        <div id="resultArea" class="space-y-4"></div>
        <button onclick="resetKey()" class="text-xs text-gray-500 underline mt-4">更換 API Key</button>
    </div>

    <script>
        let API_KEY = localStorage.getItem('MY_AI_KEY');

        async function initKey() {
            if (!API_KEY) {
                const key = prompt("請輸入 Gemini API Key：");
                if (key) { localStorage.setItem('MY_AI_KEY', key); API_KEY = key; }
            }
        }

        function resetKey() { localStorage.removeItem('MY_AI_KEY'); location.reload(); }

        document.getElementById('generateBtn').addEventListener('click', async () => {
            const promptContent = document.getElementById('userInput').value.trim();
            if (!promptContent) return alert('請輸入內容');
            await initKey();

            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('statusArea');
            const result = document.getElementById('resultArea');

            btn.disabled = true;
            status.classList.remove('hidden');
            result.innerHTML = '';

            // 修正：使用 v1beta 與 2.0-flash 確保最高成功率
            const URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

            try {
                const resp = await fetch(URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `你是一位繪圖專家。將「${promptContent}」擴充為一段詳細的英文繪圖提示詞，只輸出英文。` }] }] })
                });

                const data = await resp.json();
                if (data.error) throw new Error(data.error.message);

                const refined = data.candidates[0].content.parts[0].text;
                const imgUrl = `https://pollinations.ai/p/${encodeURIComponent(refined)}?width=1024&height=1024&seed=${Math.random()}`;

                result.innerHTML = `<div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <p class="text-xs text-gray-400 mb-2">優化提示詞：${refined}</p>
                    <img src="${imgUrl}" class="w-full rounded-lg shadow-lg" onload="document.getElementById('statusArea').classList.add('hidden')">
                </div>`;
            } catch (e) {
                alert("錯誤：" + e.message + "\n\n提示：請確認是否已在 Google Cloud Console 啟用 Generative Language API。");
                status.classList.add('hidden');
            } finally { btn.disabled = false; }
        });
        initKey();
    </script>
</body>
</html>
