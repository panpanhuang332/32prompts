<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸€æŒ‡æç¤º</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        /* --- æ ¸å¿ƒä½ˆå±€ --- */
        body { background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .app-header { background: white; padding: 15px 15px 0 15px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; }
        
        /* é ‚éƒ¨å°èˆªåˆ— */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .app-title { margin: 0; font-weight: bold; color: #343a40; font-size: 1.1rem; }
        
        /* Google ç™»å…¥æŒ‰éˆ• */
        .btn-google-login {
            font-size: 0.8rem; padding: 5px 10px; border-radius: 20px;
            background-color: white; border: 1px solid #dadce0; color: #3c4043;
            display: flex; align-items: center; gap: 5px; transition: all 0.2s; cursor: pointer;
        }
        .btn-google-login:hover { background-color: #f8f9fa; border-color: #d2e3fc; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 2px solid #4285f4; }
        .user-info { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #5f6368; cursor: pointer; }
        
        /* åˆ†é å°èˆª */
        .nav-tabs { border-bottom: none; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap; gap: 5px; padding-bottom: 5px; }
        .nav-tabs .nav-link { border: none; color: #6c757d; font-size: 0.95rem; padding: 8px 12px; border-radius: 20px; background-color: #f8f9fa; transition: all 0.2s; white-space: nowrap; position: relative; }
        .nav-tabs .nav-link.active { color: white; background-color: #4285f4; font-weight: bold; }
        
        /* ç¦ç”¨ç‹€æ…‹ (é€šç”¨) */
        .nav-tabs .nav-link.disabled-tab { opacity: 0.6; cursor: not-allowed; background-color: #e9ecef; color: #adb5bd; }
        
        /* æœƒå“¡é™åˆ¶å¾½ç«  (ç´…è‰² é™) */
        .limit-badge { color: #dc3545; font-weight: bold; font-size: 0.8em; margin-left: 2px; vertical-align: top; }
        
        /* å…§å®¹å€ */
        .app-content { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: #f0f2f5; scroll-behavior: smooth; }
        .tab-content-area { display: none; animation: fadeIn 0.3s; }
        .tab-content-area.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .category-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: opacity 0.3s; }
        .category-card.disabled-card { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        .category-title { font-size: 0.9rem; font-weight: bold; color: #343a40; margin-bottom: 8px; display: block; border-left: 4px solid #4285f4; padding-left: 8px; }
        
        /* åº•éƒ¨ */
        .app-footer { background: white; padding: 10px 15px; border-top: 1px solid #dee2e6; flex-shrink: 0; z-index: 20; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .loading-text { font-size: 0.8em; color: #4285f4; margin-top: 5px; display: none; }
        .form-select, .form-control { background-color: #f8f9fa; border: 1px solid #e9ecef; }
        
        /* äº’æ–¥é–å®šå¾½ç«  (åŸæœ¬çš„ç°è‰²é–å®š) */
        .locked-badge { display: none; font-size: 0.7rem; background: #6c757d; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        .camera-preview-box { position: relative; width: 60px; height: 60px; background: #e9ecef; border-radius: 8px; overflow: hidden; display: none; border: 2px solid #4285f4; margin-right: 10px; flex-shrink: 0; }
        .captured-image { width: 100%; height: 100%; object-fit: cover; }
        .btn-clear-img { position: absolute; top: 0; right: 0; background: rgba(220, 53, 69, 0.9); color: white; border: none; width: 20px; height: 20px; font-size: 14px; line-height: 20px; text-align: center; cursor: pointer; z-index: 5; }

        .mode-switch-container { display: flex; gap: 5px; margin-bottom: 10px; background: #f1f3f4; padding: 4px; border-radius: 8px; }
        .mode-btn { flex: 1; border: none; background: transparent; padding: 8px; font-size: 0.85rem; border-radius: 6px; color: #5f6368; font-weight: bold; transition: all 0.2s; }
        .mode-btn.active { background: white; color: #1967d2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .mode-btn.mode-reverse.active { color: #8e24aa; }

        .action-bar { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-action { flex: 1; font-weight: bold; border-radius: 8px; padding: 8px; font-size: 0.9rem; border: 1px solid transparent; }
        .btn-upload { background-color: #fff0f1; color: #dc3545; border-color: #ffcdd2; }
        .btn-random { background-color: #fff8e1; color: #f57f17; border-color: #ffecb3; }
        
        .nav-tabs::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="top-bar">
            <h6 class="app-title">â™ä¸€æŒ‡æç¤º</h6>
            
            <button id="loginBtn" class="btn-google-login" onclick="googleLogin()">
                <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                ç™»å…¥
            </button>

            <div id="userInfo" class="user-info" style="display: none;" onclick="googleLogout()">
                <span id="userName">User</span>
                <img id="userPhoto" src="" class="user-avatar" alt="Avatar">
            </div>
        </div>
        
        <div class="mode-switch-container">
            <button class="mode-btn active" onclick="setMode('create')" id="mode-create">âœ¨ ç¹ªåœ–æŒ‡ä»¤</button>
            <button class="mode-btn mode-reverse" onclick="setMode('reverse')" id="mode-reverse">ğŸ”® åæ¨æç¤ºè©</button>
        </div>

        <div class="mb-2">
            <div class="input-group mb-2" id="inputRow">
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleImageSelect(this)">
                <div id="previewBox" class="camera-preview-box">
                    <img id="finalImage" class="captured-image">
                    <button class="btn-clear-img" onclick="clearPhoto()">Ã—</button>
                </div>
                <input type="text" class="form-control" id="mainSubject" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: è²“)...">
                <button class="btn btn-outline-primary" type="button" id="translateBtn" onclick="translateInput()">ä¸­ç¿»è‹±</button>
            </div>
            
            <div class="action-bar">
                <button class="btn-action btn-upload" type="button" onclick="triggerNativeCamera()">ğŸ“¸ ä¸Šå‚³åœ–ç‰‡</button>
                <button class="btn-action btn-random" id="btnRandom" type="button" onclick="autoRandomize()">ğŸ² éš¨æ©Ÿç”¢ç”Ÿ</button>
            </div>
            <div id="translationStatus" class="loading-text">æ­£åœ¨ç¿»è­¯ä¸­...</div>
        </div>

        <div class="nav nav-tabs" id="myTab" role="tablist">
            <button class="nav-link active" onclick="switchTab(this, 'page-settings')">âš™ï¸ è¨­å®š</button>
            <button class="nav-link" onclick="switchTab(this, 'page-text')">ğŸ”¤ æ–‡å­—</button>
            <button class="nav-link" onclick="switchTab(this, 'page-char')">ğŸ‘¤ äººç‰©</button>
            <button class="nav-link" onclick="switchTab(this, 'page-scene')">ğŸï¸ å ´æ™¯</button>
            
            <button class="nav-link disabled-tab" id="btn-photo" onclick="switchTab(this, 'page-photo')">ğŸ“¸ æ”å½± <span class="limit-badge">é™</span></button>
            <button class="nav-link disabled-tab" id="btn-art" onclick="switchTab(this, 'page-art')">ğŸ–Œï¸ è—è¡“ <span class="limit-badge">é™</span> <span class="locked-badge">é–</span></button>
            <button class="nav-link disabled-tab" id="btn-anime" onclick="switchTab(this, 'page-anime')">ğŸ§¸ å‹•æ¼« <span class="limit-badge">é™</span> <span class="locked-badge">é–</span></button>
        </div>
    </div>

    <div class="app-content">
        <div id="mode-hint" class="mb-3"></div>

        <div id="page-settings" class="tab-content-area active">
            <div class="category-card">
                <label class="category-title">ğŸ“ åœ–ç‰‡æ¯”ä¾‹</label>
                <select class="form-select category-select" id="aspectRatio">
                    <option value="" selected>1:1 (é è¨­æ­£æ–¹å½¢)</option>
                    <optgroup label="æ©«å‘">
                        <option value="16:9">16:9 (å¯¬è¢å¹•/YT)</option>
                        <option value="21:9">21:9 (Notionå°é¢)</option>
                        <option value="4:3">4:3 (æ¨™æº–ç…§ç‰‡)</option>
                    </optgroup>
                    <optgroup label="ç›´å‘">
                        <option value="4:5">4:5 (IG è²¼æ–‡)</option>
                        <option value="3:4">3:4 (ç›´å¼ç…§ç‰‡)</option>
                        <option value="9:16">9:16 (é™å‹•/Reels)</option>
                    </optgroup>
                </select>
            </div>
            <div class="category-card">
                <label class="category-title">ğŸ’ è§£æåº¦</label>
                <select class="form-select category-select" id="pixelResolution">
                    <option value="" selected>é è¨­</option>
                    <optgroup label="ç¤¾ç¾¤/è¢å¹•">
                        <option value="1080x1080 px, high quality">IG æ­£æ–¹å½¢ (1080p)</option>
                        <option value="3840x2160 px, 4K UHD">4K è¶…é«˜ç•«è³ª</option>
                    </optgroup>
                    <optgroup label="å°åˆ·/æ”å½±">
                        <option value="2480x3508 px, 300DPI">A4 å°åˆ·è¦æ ¼</option>
                        <option value="6000x4000 px, 24MP">2400 è¬åƒç´ </option>
                    </optgroup>
                </select>
            </div>
        </div>

        <div id="page-text" class="tab-content-area">
            <div class="category-card">
                <label class="category-title">ğŸ”¤ æ’å…¥æ–‡å­—</label>
                <div class="mb-3">
                    <label class="form-label small">æ–‡å­—å…§å®¹</label>
                    <input type="text" class="form-control" id="textContent" placeholder="ä¾‹å¦‚: Hello World">
                </div>
                <div class="mb-3">
                    <label class="form-label small">ä½ç½®èªªæ˜</label>
                    <input type="text" class="form-control" id="textPosition" placeholder="ä¾‹å¦‚: å·¦ä¸Šè§’, æµ®åœ¨ç©ºä¸­">
                </div>
                 <div class="mb-3">
                    <label class="form-label small">å­—é«”é¢¨æ ¼</label>
                    <select class="form-select category-select" id="textFont"></select>
                </div>
            </div>
        </div>

        <div id="page-char" class="tab-content-area"><div id="container-char"></div></div>
        <div id="page-scene" class="tab-content-area"><div id="container-scene"></div></div>
        <div id="page-photo" class="tab-content-area"><div id="container-photo"></div></div>
        <div id="page-art" class="tab-content-area"><div id="container-art"></div></div>
        <div id="page-anime" class="tab-content-area"><div id="container-anime"></div></div>
    </div>

    <div class="app-footer">
        <div class="d-grid gap-2 mb-2">
            <button class="btn btn-primary fw-bold" id="generateBtn" onclick="generatePrompt()" style="background-color: #4285f4; border-color: #4285f4;">
                âœ¨ ç”¢å‡ºæŒ‡ä»¤
            </button>
        </div>
        <div class="input-group input-group-sm">
            <textarea class="form-control" id="outputPrompt" rows="3" readonly placeholder="æç¤ºè©å°‡é¡¯ç¤ºæ–¼æ­¤" style="resize: none; font-size: 0.85rem;"></textarea>
            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard()">è¤‡è£½</button>
        </div>
    </div>

<script>
    // ==========================================
    // âš ï¸ å¡«å…¥æ‚¨çš„ Firebase è¨­å®š
    // ==========================================
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    // åˆå§‹åŒ– Firebase
    let isLoggedIn = false;
    try {
        firebase.initializeApp(firebaseConfig);
    } catch(e) { console.error("Firebase Init Error", e); }

    // Google Login/Logout Logic
    function googleLogin() {
        if (!firebase.apps.length) return alert("è«‹å…ˆè¨­å®šç¨‹å¼ç¢¼ä¸­çš„ Firebase Configï¼");
        const provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider).catch((error) => alert("ç™»å…¥å¤±æ•—: " + error.message));
    }

    function googleLogout() {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) firebase.auth().signOut();
    }

    // ç›£è½ç™»å…¥ç‹€æ…‹ä¸¦æ§åˆ¶æ¬Šé™
    if (firebase.apps.length) {
        firebase.auth().onAuthStateChanged((user) => {
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            const restrictedTabs = ['btn-photo', 'btn-art', 'btn-anime'];

            if (user) {
                // å·²ç™»å…¥ï¼šè§£é–
                isLoggedIn = true;
                loginBtn.style.display = 'none';
                userInfo.style.display = 'flex';
                document.getElementById('userPhoto').src = user.photoURL;
                document.getElementById('userName').textContent = user.displayName;

                // ç§»é™¤é™åˆ¶
                restrictedTabs.forEach(id => {
                    const btn = document.getElementById(id);
                    btn.classList.remove('disabled-tab');
                    const limitBadge = btn.querySelector('.limit-badge');
                    if (limitBadge) limitBadge.remove();
                });
                
                // æ¢å¾©ã€Œäº’æ–¥é–å®šã€é‚è¼¯ (æª¢æŸ¥æ”å½±é¡å‹æ˜¯å¦å·²é¸)
                const photoType = document.getElementById('photo_type');
                if (photoType && photoType.value !== "") {
                    // å¦‚æœå·²ç¶“é¸äº†æ”å½±é¡å‹ï¼Œä¿æŒè—è¡“/å‹•æ¼«ç‚ºã€Œäº’æ–¥é–å®šã€ç‹€æ…‹
                    toggleLock('container-art', 'btn-art', true);
                    toggleLock('container-anime', 'btn-anime', true);
                } else {
                    // å¦å‰‡å…¨éƒ¨è§£é–
                    toggleLock('container-art', 'btn-art', false);
                    toggleLock('container-anime', 'btn-anime', false);
                }

            } else {
                // æœªç™»å…¥ï¼šé–å®š
                isLoggedIn = false;
                loginBtn.style.display = 'flex';
                userInfo.style.display = 'none';

                // åŠ ä¸Šé™åˆ¶
                restrictedTabs.forEach(id => {
                    const btn = document.getElementById(id);
                    btn.classList.add('disabled-tab');
                    if (!btn.querySelector('.limit-badge')) {
                        // æ’å…¥ "é™" å­—
                        btn.innerHTML = btn.innerHTML.replace(' <span class="limit-badge">é™</span>', '') + ' <span class="limit-badge">é™</span>';
                    }
                });

                // å¦‚æœç•¶å‰åœ¨é™åˆ¶åˆ†é ï¼Œå¼·åˆ¶è·³å›è¨­å®šé 
                const activeTab = document.querySelector('.nav-link.active');
                if (restrictedTabs.includes(activeTab.id)) {
                    switchTab(document.querySelector('.nav-link'), 'page-settings');
                }
            }
        });
    }

    // ==========================================
    //  ä¸»ç¨‹å¼é‚è¼¯
    // ==========================================
    let currentMode = 'create';
    const fontData = [{val: "Bold sans-serif", label: "ç²—é«”ç„¡è¥¯ç·š"}, {val: "Elegant serif", label: "å„ªé›…è¥¯ç·š"}, {val: "Handwritten script", label: "æ‰‹å¯«è‰æ›¸"}, {val: "Cyberpunk neon style", label: "è³½åšé¾å…‹éœ“è™¹"}, {val: "Vintage retro style", label: "å¾©å¤é¢¨æ ¼"}, {val: "Graffiti style", label: "å¡—é´‰é¢¨æ ¼"}, {val: "Calligraphy brush stroke", label: "æ›¸æ³•æ¯›ç­†"}, {val: "Pixel art style", label: "åƒç´ é¢¨æ ¼"}];

    const categorizedData = {
        "char": { 
            "æœè£ç©¿æ­": [{val: "T-shirt and jeans", label: "Tæ¤ç‰›ä»”è¤²"}, {val: "Suit and tie", label: "è¥¿è£"}, {val: "Evening gown", label: "æ™šç¦®æœ"}, {val: "Cyberpunk techwear", label: "æ©Ÿèƒ½é¢¨"}, {val: "Kimono", label: "å’Œæœ"}, {val: "School uniform", label: "åˆ¶æœ"}, {val: "Maid outfit", label: "å¥³åƒ•è£"}, {val: "Sportswear", label: "é‹å‹•æœ"}, {val: "Hoodie", label: "é€£å¸½è¡«"}, {val: "Armor", label: "ç›”ç”²"}],
            "é«®å‹é«®è‰²": [{val: "Long straight black hair", label: "é»‘é•·ç›´"}, {val: "Short bob cut", label: "é®‘ä¼¯é ­"}, {val: "Blonde ponytail", label: "é‡‘é«®é¦¬å°¾"}, {val: "Silver twin tails", label: "éŠ€é«®é›™é¦¬å°¾"}, {val: "Pink hair", label: "ç²‰é«®"}, {val: "Messy hair", label: "å‡Œäº‚é«®"}, {val: "Bald", label: "å…‰é ­"}, {val: "Curly hair", label: "æ²é«®"}],
            "äº”å®˜ç‰¹é»": [{val: "Blue eyes", label: "è—çœ¼"}, {val: "Red eyes", label: "ç´…çœ¼"}, {val: "Heterochromia", label: "ç•°è‰²ç³"}, {val: "Cat eyes", label: "è²“çœ¼"}, {val: "Wearing glasses", label: "çœ¼é¡"}, {val: "Freckles", label: "é›€æ–‘"}, {val: "Scar on face", label: "åˆ€ç–¤"}, {val: "Makeup", label: "åŒ–å¦"}],
            "è¡¨æƒ…": [{val: "Smile", label: "å¾®ç¬‘"}, {val: "Laughing", label: "å¤§ç¬‘"}, {val: "Crying", label: "å“­æ³£"}, {val: "Angry", label: "ç”Ÿæ°£"}, {val: "Expressionless", label: "ç„¡è¡¨æƒ…"}, {val: "Seductive", label: "èª˜æƒ‘"}, {val: "Surprised", label: "é©šè¨"}, {val: "Winking", label: "çœ¨çœ¼"}],
            "è‚¢é«”å‹•ä½œ": [{val: "Standing", label: "ç«™ç«‹"}, {val: "Sitting", label: "åè‘—"}, {val: "Lying", label: "èººè‘—"}, {val: "Running", label: "å¥”è·‘"}, {val: "Jumping", label: "è·³èº"}, {val: "Fighting stance", label: "æˆ°é¬¥å§¿å‹¢"}, {val: "Peace sign", label: "æ¯”YA"}, {val: "Looking back", label: "å›çœ¸"}],
            "é«”å‹": [{val: "Slim", label: "è‹—æ¢"}, {val: "Muscular", label: "è‚Œè‚‰"}, {val: "Curvy", label: "æ›²ç·š"}, {val: "Chubby", label: "è‚‰æ„Ÿ"}, {val: "Tall", label: "é«˜æŒ‘"}, {val: "Petite", label: "å¬Œå°"}]
        },
        "scene": { 
            "ç’°å¢ƒè¨­å®š": [{val: "Indoor", label: "å®¤å…§"}, {val: "Outdoor", label: "å®¤å¤–"}, {val: "Primitive Forest", label: "åŸå§‹æ£®æ—"}, {val: "Underwater", label: "æµ·åº•"}, {val: "Outer Space", label: "å¤ªç©º"}, {val: "Concert Stage", label: "æ¼”å”±æœƒ"}, {val: "Future City", label: "æœªä¾†åŸå¸‚"}],
            "ç‰¹å®šåœ°é»": [{val: "News Anchor Desk", label: "ä¸»æ’­å°"}, {val: "Church", label: "æ•™å ‚"}, {val: "Rooftop style of Infernal Affairs", label: "ç„¡é–“é“å¤©å°"}, {val: "Prison Cell", label: "ç›£ç„"}, {val: "Courtroom", label: "æ³•é™¢"}, {val: "Classroom", label: "æ•™å®¤"}, {val: "Cyberpunk Street", label: "è³½åšè¡—é“"}, {val: "Ancient Temple", label: "å¤å»Ÿ"}],
            "èƒŒæ™¯è™•ç†": [{val: "White Background", label: "ç™½èƒŒæ™¯"}, {val: "Simple Background", label: "ç°¡å–®èƒŒæ™¯"}, {val: "No Background", label: "ç„¡èƒŒæ™¯/å»èƒŒ"}, {val: "Green Screen", label: "ç¶ å¹•"}]
        },
        "photo": { 
            "æ”å½±é¡å‹": [{id: "photo_type", val: "photo", label: "ç…§ç‰‡"}, {id: "photo_type", val: "portrait photography", label: "äººåƒ"}, {id: "photo_type", val: "life photo", label: "ç”Ÿæ´»ç…§"}, {id: "photo_type", val: "sports photography", label: "é‹å‹•"}, {id: "photo_type", val: "still life photo", label: "éœç‰©"}, {id: "photo_type", val: "selfie photo", label: "è‡ªæ‹"}],
            "å…‰åœˆ": [{id:"photo_aperture", val:"f/1.4", label:"f/1.4"}, {id:"photo_aperture", val:"f/2.8", label:"f/2.8"}, {id:"photo_aperture", val:"f/8", label:"f/8"}, {id:"photo_aperture", val:"f/16", label:"f/16"}, {id:"photo_aperture", val:"f/32", label:"f/32"}],
            "ç„¦è·": [{id:"photo_focal", val:"20mm", label:"20mm (è¶…å»£)"}, {id:"photo_focal", val:"35mm", label:"35mm (äººæ–‡)"}, {id:"photo_focal", val:"85mm", label:"85mm (äººåƒ)"}, {id:"photo_focal", val:"200mm", label:"200mm (æœ›é )"}, {id:"photo_focal", val:"macro lens", label:"å¾®è·é¡é ­"}, {id:"photo_focal", val:"fish eye lens", label:"é­šçœ¼"}],
            "é¢¨æ ¼": [{val:"DSLR style", label:"æ•¸ä½å–®çœ¼"}, {val:"Polaroid style", label:"æ‹ç«‹å¾—"}, {val:"gopro style", label:"GoPro"}, {val:"Fujifilm superia style", label:"å¯Œå£«åº•ç‰‡"}, {val:"LOMO style", label:"LOMO"}, {val:"movie style", label:"é›»å½±é¢¨"}, {val:"cinematic photo style", label:"åŠ‡ç…§"}, {val:"vintage photo style", label:"å¾©å¤"}, {val:"Holga photography", label:"Holga"}, {val:"Anthotype print", label:"æ¤ç‰©æ„Ÿå…‰"}],
            "å…‰å½±èˆ‡æ•ˆæœ": [{val:"bokeh", label:"æ•£æ™¯"}, {val:"lens flare", label:"é¡é ­çœ©å…‰"}, {val:"magic hour", label:"é­”å¹»æ™‚åˆ»"}, {val:"golden hour", label:"é»ƒé‡‘æ™‚åˆ»"}, {val:"blue hour", label:"è—è‰²æ™‚åˆ»"}, {val:"ambient light", label:"ç’°å¢ƒå…‰"}, {val:"hard light", label:"ç¡¬å…‰"}, {val:"soft light", label:"æŸ”å…‰"}, {val:"back light", label:"èƒŒå…‰"}, {val:"HDR", label:"HDR"}, {val:"double exposure", label:"é‡è¤‡æ›å…‰"}, {val:"motion blur", label:"å‹•æ…‹æ¨¡ç³Š"}],
            "ç•«é¢è§’åº¦": [{val:"face close-up", label:"è‡‰éƒ¨ç‰¹å¯«"}, {val:"full body shot", label:"å…¨èº«ç…§"}, {val:"low angle view", label:"ä½è§’åº¦"}, {val:"high angle view", label:"é«˜è§’åº¦"}, {val:"bird view", label:"é³¥ç°"}, {val:"knolling", label:"é–‹ç®±ç…§/å¹³é‹ª"}, {val:"product view", label:"ç”¢å“ç‰¹å¯«"}, {val:"360 degrees photo", label:"360åº¦"}, {val:"X-ray view", label:"Xå…‰ç‰‡"}]
        },
        "art": { 
            "ç¹ªç•«åª’æ": [{val:"illustration", label:"æ’ç•«"}, {val:"pencil", label:"é‰›ç­†"}, {val:"charcoal", label:"ç‚­ç­†"}, {val:"color pencil", label:"è‰²é‰›ç­†"}, {val:"acrylic painting", label:"å£“å…‹åŠ›"}, {val:"watercolor painting", label:"æ°´å½©"}, {val:"oil painting", label:"æ²¹ç•«"}, {val:"ink drawing", label:"æ°´å¢¨"}, {val:"Woodcut", label:"ç‰ˆç•«"}, {val:"vector art", label:"å‘é‡åœ–"}],
            "æè³ª": [{val:"paper art", label:"ç´™é›•"}, {val:"origami art", label:"æ‘ºç´™"}, {val:"stained glass", label:"å½©ç¹ªç»ç’ƒ"}, {val:"mosaic", label:"é¦¬è³½å…‹"}, {val:"pixel art", label:"åƒç´ ç•«"}, {val:"Low poly", label:"ä½å¤šé‚Šå½¢"}, {val:"wood carving", label:"æœ¨é›•"}, {val:"lego", label:"æ¨‚é«˜"}, {val:"felt doll", label:"ç¾Šæ¯›æ°ˆ"}, {val:"neon light", label:"éœ“è™¹ç‡ˆ"}],
            "æµæ´¾": [{val:"Impressionnisme", label:"å°è±¡æ´¾"}, {val:"Surrealism", label:"è¶…ç¾å¯¦"}, {val:"Cubism", label:"ç«‹é«”ä¸»ç¾©"}, {val:"Pop Art", label:"æ™®æ™®"}, {val:"Minimalism", label:"æ¥µç°¡"}, {val:"Cyber Art", label:"è³½åšè—è¡“"}, {val:"Steampunk", label:"è’¸æ°£é¾å…‹"}, {val:"Ukiyo-e", label:"æµ®ä¸–ç¹ª"}, {val:"Baroque art", label:"å·´æ´›å…‹"}],
            "è—è¡“å®¶": [{val:"Vincent van Gogh", label:"æ¢µè°·"}, {val:"Leonardo da Vinci", label:"é”æ–‡è¥¿"}, {val:"Picasso", label:"ç•¢å¡ç´¢"}, {val:"Dali", label:"é”åˆ©"}, {val:"Monet", label:"è«å…§"}, {val:"Mucha", label:"æ…•å¤"}, {val:"Andy Warhol", label:"å®‰è¿ªæ²ƒè·"}, {val:"Hayao Miyazaki", label:"å®®å´é§¿"}, {val:"Makoto Shinkai", label:"æ–°æµ·èª "}, {val:"Yayoi Kusama", label:"è‰é–“å½Œç”Ÿ"}]
        },
        "anime": { 
            "ä½œå“": [{val: "One Piece style", label: "èˆªæµ·ç‹"}, {val: "Detective Conan style", label: "ååµæ¢æŸ¯å—"}, {val: "Naruto style", label: "ç«å½±å¿è€…"}, {val: "Slam Dunk style", label: "çŒç±ƒé«˜æ‰‹"}, {val: "style of Mitsuru Adachi", label: "å®‰é”å……é¢¨æ ¼"}, {val: "Fist of the North Star style", label: "åŒ—æ–—ç¥æ‹³"}, {val: "Saint Seiya style", label: "è–é¬¥å£«æ˜ŸçŸ¢"}, {val: "A Certain Scientific Railgun style", label: "æŸç§‘å­¸çš„è¶…é›»ç£ç ²"}, {val: "Studio Ghibli style", label: "å‰åœåŠ›"}, {val: "Dragon ball style", label: "ä¸ƒé¾ç "}, {val: "Sailor Moon style", label: "ç¾å°‘å¥³æˆ°å£«"}, {val: "JoJo style", label: "JoJo"}],
            "é¡å‹èˆ‡å…¬å¸": [{val:"2D cartoon", label:"2D å¡é€š"}, {val:"3D cartoon", label:"3D å¡é€š"}, {val:"American comic book", label:"ç¾å¼æ¼«ç•«"}, {val:"Manga", label:"æ—¥å¼æ¼«ç•«"}, {val:"Pixar Animation", label:"çš®å…‹æ–¯"}, {val:"Disney Animation", label:"è¿ªå£«å°¼"}, {val:"Kyoto Animation", label:"äº¬éƒ½å‹•ç•«"}, {val:"Marvel Animation", label:"æ¼«å¨"}],
            "è¨­è¨ˆ": [{val:"mascot logo", label:"å‰ç¥¥ç‰© Logo"}, {val:"UI design", label:"UI ä»‹é¢"}, {val:"3D Model Exploded View", label:"3D åˆ†è§£åœ–"}, {val:"2D floor plan", label:"2D å¹³é¢åœ–"}, {val:"character toy", label:"å…¬ä»”ç©å…·"}]
        }
    };

    function init() {
        const fontSelect = document.getElementById('textFont');
        fontSelect.appendChild(new Option("ä¸æŒ‡å®š", ""));
        fontData.forEach(item => fontSelect.appendChild(new Option(item.label, item.val)));

        for (const [tabKey, categories] of Object.entries(categorizedData)) {
            const container = document.getElementById(`container-${tabKey}`);
            if (!container) continue;
            for (const [catName, items] of Object.entries(categories)) {
                const card = document.createElement('div'); card.className = 'category-card';
                const label = document.createElement('label'); label.className = 'category-title'; label.textContent = catName;
                card.appendChild(label);
                const select = document.createElement('select'); select.className = 'form-select category-select';
                if (items.length > 0 && items[0].id) select.id = items[0].id;
                select.appendChild(new Option("ä¸æŒ‡å®š", ""));
                items.forEach(item => select.appendChild(new Option(item.label, item.val)));
                card.appendChild(select);
                container.appendChild(card);
            }
        }
        
        // æ”å½±äº’æ–¥é‚è¼¯
        const photoType = document.getElementById('photo_type');
        if (photoType) {
            photoType.addEventListener('change', function() {
                if (!isLoggedIn) return; // æœªç™»å…¥ä¸è™•ç†ï¼Œå› ç‚ºæœ¬ä¾†å°±é–ä½äº†
                
                const isPhoto = this.value !== "";
                ['photo_aperture', 'photo_focal'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) { el.disabled = !isPhoto; if(!isPhoto) el.value=""; }
                });
                toggleLock('container-art', 'btn-art', isPhoto);
                toggleLock('container-anime', 'btn-anime', isPhoto);
            });
        }
        ['photo_aperture', 'photo_focal'].forEach(id => { const el = document.getElementById(id); if(el) el.disabled = true; });
        
        setMode('create');
    }

    function toggleLock(cid, bid, lock) {
        // é€™å€‹å‡½å¼ç¾åœ¨ä¸»è¦ç”¨æ–¼ã€Œæ”å½±äº’æ–¥ã€ï¼Œæ¬Šé™é–å®šç”± Firebase Auth Listener æ§åˆ¶
        if (!isLoggedIn) return; // å¦‚æœæ²’ç™»å…¥ï¼Œå…¨éƒ¨äº¤çµ¦ Auth Listener æ§åˆ¶

        const c = document.getElementById(cid), b = document.getElementById(bid);
        c.querySelectorAll('select').forEach(s => { s.disabled = lock; if(lock) s.value=""; });
        
        // åªæœ‰åœ¨äº’æ–¥é‚è¼¯ä¸‹ï¼Œæ‰é¡¯ç¤ºã€Œé–ã€å­—ï¼Œä¸å½±éŸ¿ã€Œé™ã€å­—
        b.querySelector('.locked-badge').style.display = lock ? 'inline-block' : 'none';
        
        // è¦–è¦ºè®Šç°ï¼Œä½†ä¸å½±éŸ¿ç™»å…¥é™åˆ¶çš„ç´…è‰²ã€Œé™ã€
        b.classList.toggle('disabled-tab', lock); 
        c.querySelectorAll('.category-card').forEach(card => card.classList.toggle('disabled-card', lock));
    }

    // --- æ¬Šé™åˆ¤æ–·é»é¸ ---
    function switchTab(btn, targetId) {
        // å¦‚æœæ˜¯æŒ‰åˆ°äº†è¢«æ¬Šé™é–ä½(limit-badge)çš„æŒ‰éˆ•ï¼Œæˆ–è€…æ˜¯è¢«äº’æ–¥é–ä½(locked-badge)çš„æŒ‰éˆ•
        if (btn.classList.contains('disabled-tab')) {
            if (btn.querySelector('.limit-badge')) {
                alert("ğŸ”’ æœƒå“¡é™å®šåŠŸèƒ½\n\nè«‹é»é¸å³ä¸Šè§’ã€Œç™»å…¥ã€Google å¸³è™Ÿä»¥è§£é–æ­¤åŠŸèƒ½ï¼");
            } else if (btn.querySelector('.locked-badge') && btn.querySelector('.locked-badge').style.display !== 'none') {
                alert("âš ï¸ æ¨¡å¼è¡çª\n\næ‚¨å·²é¸æ“‡ã€Œæ”å½±é¡å‹ã€ï¼Œå› æ­¤ç„¡æ³•åŒæ™‚é¸æ“‡è—è¡“/å‹•æ¼«é¢¨æ ¼ã€‚\nè«‹å…ˆå°‡æ”å½±é¡å‹è¨­ç‚ºã€Œä¸æŒ‡å®šã€å³å¯è§£é–ã€‚");
            }
            return;
        }

        document.querySelectorAll('.nav-link').forEach(b => {
            b.classList.remove('active'); b.style.backgroundColor='#f8f9fa'; b.style.color='#6c757d';
        });
        btn.classList.add('active'); btn.style.backgroundColor='#4285f4'; btn.style.color='white';
        document.querySelectorAll('.tab-content-area').forEach(div => div.classList.remove('active'));
        document.getElementById(targetId).classList.add('active');
    }

    // (å…¶é¤˜åŠŸèƒ½å‡½å¼ä¿æŒä¸è®Š)
    function setMode(mode) {
        currentMode = mode;
        const els = ['inputRow', 'btnRandom', 'myTab'];
        const isReverse = mode === 'reverse';
        document.getElementById('mode-create').classList.toggle('active', !isReverse);
        document.getElementById('mode-reverse').classList.toggle('active', isReverse);
        els.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = isReverse ? 'none' : (id === 'inputRow' || id === 'myTab' ? 'flex' : 'block');
        });
        const hint = document.getElementById('mode-hint');
        const genBtn = document.getElementById('generateBtn');
        if (isReverse) {
            switchTab(document.querySelector('.nav-link'), 'page-settings');
            hint.innerHTML = `<div style="background: #f3e5f5; padding: 10px; border-radius: 8px; color: #6a1b9a;"><strong>ğŸ”® åæ¨æç¤ºè©æ¨¡å¼</strong><br>1. æŒ‰ã€Œä¸Šå‚³åœ–ç‰‡ã€ã€‚<br>2. æŒ‰ç”¢å‡ºï¼Œè¤‡è£½æŒ‡ä»¤ã€‚<br>3. åœ¨ Gemini è²¼ä¸Šæ–‡å­—ä¸¦<b>ä¸Šå‚³åœ–ç‰‡</b>ã€‚</div>`;
            genBtn.textContent = "ğŸ” ç”¢å‡ºåˆ†ææŒ‡ä»¤";
            genBtn.style.backgroundColor = "#8e24aa";
            genBtn.style.borderColor = "#8e24aa";
        } else {
            hint.innerHTML = "";
            genBtn.textContent = "âœ¨ ç”¢å‡ºç¹ªåœ–æŒ‡ä»¤";
            genBtn.style.backgroundColor = "#4285f4";
            genBtn.style.borderColor = "#4285f4";
        }
    }

    function autoRandomize() {
        if (currentMode === 'reverse') return;
        let activeTabId = document.querySelector('.tab-content-area.active').id;
        
        // æª¢æŸ¥éš¨æ©Ÿç›®æ¨™æ˜¯å¦è¢«é–å®š
        if (['page-photo', 'page-art', 'page-anime'].includes(activeTabId)) {
             const currentBtn = document.querySelector(`.nav-link[onclick*='${activeTabId}']`);
             if (currentBtn && currentBtn.classList.contains('disabled-tab')) {
                 alert("æ­¤å€åŸŸå°šæœªè§£é–ï¼Œç„¡æ³•éš¨æ©Ÿç”¢ç”Ÿå–”ï¼");
                 return;
             }
        }

        let targetContainer = "";
        if (activeTabId === 'page-settings' || activeTabId === 'page-text') {
            switchTab(document.querySelectorAll('.nav-link')[3], 'page-char'); // æ”¹è·³äººç‰©
            targetContainer = 'container-char';
        } else {
            targetContainer = activeTabId.replace('page-', 'container-');
        }
        const container = document.getElementById(targetContainer);
        if (!container) return;
        let changedCount = 0;
        container.querySelectorAll('select.category-select').forEach(select => {
            if (select.disabled) return;
            const options = select.options;
            if (options.length > 1) {
                select.selectedIndex = Math.floor(Math.random() * (options.length - 1)) + 1;
                select.dispatchEvent(new Event('change'));
                changedCount++;
            }
        });
        if (activeTabId === 'page-text') {
             const sampleTexts = ["Hello World", "Gemini AI", "Creative Mode", "ä¿æŒå¥½å¥‡", "æ—©å®‰"];
             const samplePositions = ["Top left", "Bottom right, glowing", "Centered, floating"];
             document.getElementById('textContent').value = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
             document.getElementById('textPosition').value = samplePositions[Math.floor(Math.random() * samplePositions.length)];
             changedCount++;
        }
        if (changedCount > 0) {
            generatePrompt();
            const btn = document.getElementById('btnRandom');
            const originalText = btn.textContent;
            btn.textContent = "âœ…";
            setTimeout(() => btn.textContent = originalText, 1000);
        }
    }

    function triggerNativeCamera() { document.getElementById('cameraInput').click(); }
    
    function handleImageSelect(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('finalImage').src = e.target.result;
                document.getElementById('previewBox').style.display = 'block';
                if (currentMode === 'create') {
                    const subj = document.getElementById('mainSubject');
                    if (!subj.value.trim()) subj.value = "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]";
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function clearPhoto() {
        document.getElementById('finalImage').src = "";
        document.getElementById('previewBox').style.display = 'none';
        document.getElementById('cameraInput').value = "";
        const input = document.getElementById('mainSubject');
        if (input.value === "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]") input.value = "";
    }

    async function generatePrompt() {
        const aspectRatio = document.getElementById('aspectRatio').value;
        const pixelRes = document.getElementById('pixelResolution').value;
        const hasPhoto = document.getElementById('finalImage').getAttribute('src') !== "";
        const txtContent = document.getElementById('textContent').value.trim();
        const txtPosition = document.getElementById('textPosition').value.trim();
        const txtFont = document.getElementById('textFont').value;
        let parts = [];

        if (currentMode === 'reverse') {
            if (!hasPhoto) { alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼"); return; }
            parts.push("You are an expert Prompt Engineer.");
            parts.push("Please analyze the attached image in extreme detail.");
            parts.push("Provide a comprehensive text prompt that could generate this exact image.");
            parts.push("Output format: A single, high-quality descriptive paragraph in English.");
        } else {
            let mainSubject = document.getElementById('mainSubject').value.trim();
            const btn = document.getElementById('generateBtn');
            if (/[\u4e00-\u9fa5]/.test(mainSubject) && mainSubject !== "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]") {
                const originalText = btn.textContent;
                btn.textContent = "â³ ç¿»è­¯ä¸­...";
                btn.disabled = true;
                mainSubject = await translateInput() || mainSubject;
                btn.textContent = originalText;
                btn.disabled = false;
            }
            if (hasPhoto) {
                parts.push("INSTRUCTION: Analyze the attached image deeply.");
                parts.push("1. Identify the pose, composition, and main elements.");
                if (mainSubject && mainSubject !== "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]") {
                    parts.push(`2. Modification Request: Transform the subject into: ${mainSubject}.`);
                } else {
                    parts.push("2. Recreate this image maintaining the original composition.");
                }
            } else {
                parts.push("Generate an image with the following description:");
                if (mainSubject) parts.push(`Subject: ${mainSubject}.`);
            }
            if (txtContent) {
                 parts.push(`INSTRUCTION: Insert text into the image.`);
                 parts.push(`Text Content: "${txtContent}".`);
                 if (txtPosition) parts.push(`Text Position: ${txtPosition}.`);
                 if (txtFont) parts.push(`Font Style: ${txtFont}.`);
            }
            let details = [];
            document.querySelectorAll('.category-select').forEach(select => {
                if (select.value && !select.disabled && select.id !== 'aspectRatio' && select.id !== 'pixelResolution' && select.id !== 'textFont') {
                    details.push(select.value);
                }
            });
            if (details.length > 0) parts.push(`Details, Scene & Style: ${details.join(', ')}.`);
            if (pixelRes) parts.push(`Quality/Resolution: ${pixelRes}.`);
            if (aspectRatio) parts.push(`Aspect Ratio: ${aspectRatio}.`);
            parts.push("Ensure the output is highly detailed and aesthetically pleasing.");
        }
        document.getElementById('outputPrompt').value = parts.join(' ');
    }

    async function translateInput() {
        const text = document.getElementById('mainSubject').value.trim();
        try {
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh-TW|en`);
            const data = await res.json();
            return data.responseData?.translatedText;
        } catch (e) { return text; }
    }

    function copyToClipboard() {
        const el = document.getElementById("outputPrompt");
        el.select(); navigator.clipboard.writeText(el.value);
    }

    init();
    if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
</script>
</body>
</html><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI å…¨èƒ½å·¥å…·ç®± (æœƒå“¡æ¬Šé™ç‰ˆ)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        /* --- æ ¸å¿ƒä½ˆå±€ --- */
        body { background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .app-header { background: white; padding: 15px 15px 0 15px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; }
        
        /* é ‚éƒ¨å°èˆªåˆ— */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .app-title { margin: 0; font-weight: bold; color: #343a40; font-size: 1.1rem; }
        
        /* Google ç™»å…¥æŒ‰éˆ• */
        .btn-google-login {
            font-size: 0.8rem; padding: 5px 10px; border-radius: 20px;
            background-color: white; border: 1px solid #dadce0; color: #3c4043;
            display: flex; align-items: center; gap: 5px; transition: all 0.2s; cursor: pointer;
        }
        .btn-google-login:hover { background-color: #f8f9fa; border-color: #d2e3fc; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 2px solid #4285f4; }
        .user-info { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #5f6368; cursor: pointer; }
        
        /* åˆ†é å°èˆª */
        .nav-tabs { border-bottom: none; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap; gap: 5px; padding-bottom: 5px; }
        .nav-tabs .nav-link { border: none; color: #6c757d; font-size: 0.95rem; padding: 8px 12px; border-radius: 20px; background-color: #f8f9fa; transition: all 0.2s; white-space: nowrap; position: relative; }
        .nav-tabs .nav-link.active { color: white; background-color: #4285f4; font-weight: bold; }
        
        /* ç¦ç”¨ç‹€æ…‹ (é€šç”¨) */
        .nav-tabs .nav-link.disabled-tab { opacity: 0.6; cursor: not-allowed; background-color: #e9ecef; color: #adb5bd; }
        
        /* æœƒå“¡é™åˆ¶å¾½ç«  (ç´…è‰² é™) */
        .limit-badge { color: #dc3545; font-weight: bold; font-size: 0.8em; margin-left: 2px; vertical-align: top; }
        
        /* å…§å®¹å€ */
        .app-content { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: #f0f2f5; scroll-behavior: smooth; }
        .tab-content-area { display: none; animation: fadeIn 0.3s; }
        .tab-content-area.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .category-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: opacity 0.3s; }
        .category-card.disabled-card { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        .category-title { font-size: 0.9rem; font-weight: bold; color: #343a40; margin-bottom: 8px; display: block; border-left: 4px solid #4285f4; padding-left: 8px; }
        
        /* åº•éƒ¨ */
        .app-footer { background: white; padding: 10px 15px; border-top: 1px solid #dee2e6; flex-shrink: 0; z-index: 20; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .loading-text { font-size: 0.8em; color: #4285f4; margin-top: 5px; display: none; }
        .form-select, .form-control { background-color: #f8f9fa; border: 1px solid #e9ecef; }
        
        /* äº’æ–¥é–å®šå¾½ç«  (åŸæœ¬çš„ç°è‰²é–å®š) */
        .locked-badge { display: none; font-size: 0.7rem; background: #6c757d; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        .camera-preview-box { position: relative; width: 60px; height: 60px; background: #e9ecef; border-radius: 8px; overflow: hidden; display: none; border: 2px solid #4285f4; margin-right: 10px; flex-shrink: 0; }
        .captured-image { width: 100%; height: 100%; object-fit: cover; }
        .btn-clear-img { position: absolute; top: 0; right: 0; background: rgba(220, 53, 69, 0.9); color: white; border: none; width: 20px; height: 20px; font-size: 14px; line-height: 20px; text-align: center; cursor: pointer; z-index: 5; }

        .mode-switch-container { display: flex; gap: 5px; margin-bottom: 10px; background: #f1f3f4; padding: 4px; border-radius: 8px; }
        .mode-btn { flex: 1; border: none; background: transparent; padding: 8px; font-size: 0.85rem; border-radius: 6px; color: #5f6368; font-weight: bold; transition: all 0.2s; }
        .mode-btn.active { background: white; color: #1967d2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .mode-btn.mode-reverse.active { color: #8e24aa; }

        .action-bar { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-action { flex: 1; font-weight: bold; border-radius: 8px; padding: 8px; font-size: 0.9rem; border: 1px solid transparent; }
        .btn-upload { background-color: #fff0f1; color: #dc3545; border-color: #ffcdd2; }
        .btn-random { background-color: #fff8e1; color: #f57f17; border-color: #ffecb3; }
        
        .nav-tabs::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="top-bar">
            <h6 class="app-title">ğŸ¨ AI å…¨èƒ½å·¥å…·ç®±</h6>
            
            <button id="loginBtn" class="btn-google-login" onclick="googleLogin()">
                <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                ç™»å…¥
            </button>

            <div id="userInfo" class="user-info" style="display: none;" onclick="googleLogout()">
                <span id="userName">User</span>
                <img id="userPhoto" src="" class="user-avatar" alt="Avatar">
            </div>
        </div>
        
        <div class="mode-switch-container">
            <button class="mode-btn active" onclick="setMode('create')" id="mode-create">âœ¨ ç¹ªåœ–æŒ‡ä»¤</button>
            <button class="mode-btn mode-reverse" onclick="setMode('reverse')" id="mode-reverse">ğŸ”® åæ¨æç¤ºè©</button>
        </div>

        <div class="mb-2">
            <div class="input-group mb-2" id="inputRow">
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleImageSelect(this)">
                <div id="previewBox" class="camera-preview-box">
                    <img id="finalImage" class="captured-image">
                    <button class="btn-clear-img" onclick="clearPhoto()">Ã—</button>
                </div>
                <input type="text" class="form-control" id="mainSubject" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: è²“)...">
                <button class="btn btn-outline-primary" type="button" id="translateBtn" onclick="translateInput()">ä¸­ç¿»è‹±</button>
            </div>
            
            <div class="action-bar">
                <button class="btn-action btn-upload" type="button" onclick="triggerNativeCamera()">ğŸ“¸ ä¸Šå‚³åœ–ç‰‡</button>
                <button class="btn-action btn-random" id="btnRandom" type="button" onclick="autoRandomize()">ğŸ² éš¨æ©Ÿç”¢ç”Ÿ</button>
            </div>
            <div id="translationStatus" class="loading-text">æ­£åœ¨ç¿»è­¯ä¸­...</div>
        </div>

        <div class="nav nav-tabs" id="myTab" role="tablist">
            <button class="nav-link active" onclick="switchTab(this, 'page-settings')">âš™ï¸ è¨­å®š</button>
            <button class="nav-link" onclick="switchTab(this, 'page-text')">ğŸ”¤ æ–‡å­—</button>
            <button class="nav-link" onclick="switchTab(this, 'page-char')">ğŸ‘¤ äººç‰©</button>
            <button class="nav-link" onclick="switchTab(this, 'page-scene')">ğŸï¸ å ´æ™¯</button>
            
            <button class="nav-link disabled-tab" id="btn-photo" onclick="switchTab(this, 'page-photo')">ğŸ“¸ æ”å½± <span class="limit-badge">é™</span></button>
            <button class="nav-link disabled-tab" id="btn-art" onclick="switchTab(this, 'page-art')">ğŸ–Œï¸ è—è¡“ <span class="limit-badge">é™</span> <span class="locked-badge">é–</span></button>
            <button class="nav-link disabled-tab" id="btn-anime" onclick="switchTab(this, 'page-anime')">ğŸ§¸ å‹•æ¼« <span class="limit-badge">é™</span> <span class="locked-badge">é–</span></button>
        </div>
    </div>

    <div class="app-content">
        <div id="mode-hint" class="mb-3"></div>

        <div id="page-settings" class="tab-content-area active">
            <div class="category-card">
                <label class="category-title">ğŸ“ åœ–ç‰‡æ¯”ä¾‹</label>
                <select class="form-select category-select" id="aspectRatio">
                    <option value="" selected>1:1 (é è¨­æ­£æ–¹å½¢)</option>
                    <optgroup label="æ©«å‘">
                        <option value="16:9">16:9 (å¯¬è¢å¹•/YT)</option>
                        <option value="21:9">21:9 (Notionå°é¢)</option>
                        <option value="4:3">4:3 (æ¨™æº–ç…§ç‰‡)</option>
                    </optgroup>
                    <optgroup label="ç›´å‘">
                        <option value="4:5">4:5 (IG è²¼æ–‡)</option>
                        <option value="3:4">3:4 (ç›´å¼ç…§ç‰‡)</option>
                        <option value="9:16">9:16 (é™å‹•/Reels)</option>
                    </optgroup>
                </select>
            </div>
            <div class="category-card">
                <label class="category-title">ğŸ’ è§£æåº¦</label>
                <select class="form-select category-select" id="pixelResolution">
                    <option value="" selected>é è¨­</option>
                    <optgroup label="ç¤¾ç¾¤/è¢å¹•">
                        <option value="1080x1080 px, high quality">IG æ­£æ–¹å½¢ (1080p)</option>
                        <option value="3840x2160 px, 4K UHD">4K è¶…é«˜ç•«è³ª</option>
                    </optgroup>
                    <optgroup label="å°åˆ·/æ”å½±">
                        <option value="2480x3508 px, 300DPI">A4 å°åˆ·è¦æ ¼</option>
                        <option value="6000x4000 px, 24MP">2400 è¬åƒç´ </option>
                    </optgroup>
                </select>
            </div>
        </div>

        <div id="page-text" class="tab-content-area">
            <div class="category-card">
                <label class="category-title">ğŸ”¤ æ’å…¥æ–‡å­—</label>
                <div class="mb-3">
                    <label class="form-label small">æ–‡å­—å…§å®¹</label>
                    <input type="text" class="form-control" id="textContent" placeholder="ä¾‹å¦‚: Hello World">
                </div>
                <div class="mb-3">
                    <label class="form-label small">ä½ç½®èªªæ˜</label>
                    <input type="text" class="form-control" id="textPosition" placeholder="ä¾‹å¦‚: å·¦ä¸Šè§’, æµ®åœ¨ç©ºä¸­">
                </div>
                 <div class="mb-3">
                    <label class="form-label small">å­—é«”é¢¨æ ¼</label>
                    <select class="form-select category-select" id="textFont"></select>
                </div>
            </div>
        </div>

        <div id="page-char" class="tab-content-area"><div id="container-char"></div></div>
        <div id="page-scene" class="tab-content-area"><div id="container-scene"></div></div>
        <div id="page-photo" class="tab-content-area"><div id="container-photo"></div></div>
        <div id="page-art" class="tab-content-area"><div id="container-art"></div></div>
        <div id="page-anime" class="tab-content-area"><div id="container-anime"></div></div>
    </div>

    <div class="app-footer">
        <div class="d-grid gap-2 mb-2">
            <button class="btn btn-primary fw-bold" id="generateBtn" onclick="generatePrompt()" style="background-color: #4285f4; border-color: #4285f4;">
                âœ¨ ç”¢å‡ºæŒ‡ä»¤
            </button>
        </div>
        <div class="input-group input-group-sm">
            <textarea class="form-control" id="outputPrompt" rows="3" readonly placeholder="æç¤ºè©å°‡é¡¯ç¤ºæ–¼æ­¤" style="resize: none; font-size: 0.85rem;"></textarea>
            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard()">è¤‡è£½</button>
        </div>
    </div>

<script>
    // ==========================================
    // âš ï¸ å¡«å…¥æ‚¨çš„ Firebase è¨­å®š
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyBHwTNxIIQ0dZVI6beyZa4K5S3y8Brh96g",
        authDomain: "ntu-test-54b93.firebaseapp.com",
        projectId: "ntu-test-54b93",
        storageBucket: "ntu-test-54b93.firebasestorage.app",
        messagingSenderId: "953553108630",
        appId: "1:953553108630:web:6081f44a95a0baf71e4cb7"
    };


    // åˆå§‹åŒ– Firebase
    let isLoggedIn = false;
    try {
        firebase.initializeApp(firebaseConfig);
    } catch(e) { console.error("Firebase Init Error", e); }

    // Google Login/Logout Logic
    function googleLogin() {
        if (!firebase.apps.length) return alert("è«‹å…ˆè¨­å®šç¨‹å¼ç¢¼ä¸­çš„ Firebase Configï¼");
        const provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider).catch((error) => alert("ç™»å…¥å¤±æ•—: " + error.message));
    }

    function googleLogout() {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) firebase.auth().signOut();
    }

    // ç›£è½ç™»å…¥ç‹€æ…‹ä¸¦æ§åˆ¶æ¬Šé™
    if (firebase.apps.length) {
        firebase.auth().onAuthStateChanged((user) => {
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            const restrictedTabs = ['btn-photo', 'btn-art', 'btn-anime'];

            if (user) {
                // å·²ç™»å…¥ï¼šè§£é–
                isLoggedIn = true;
                loginBtn.style.display = 'none';
                userInfo.style.display = 'flex';
                document.getElementById('userPhoto').src = user.photoURL;
                document.getElementById('userName').textContent = user.displayName;

                // ç§»é™¤é™åˆ¶
                restrictedTabs.forEach(id => {
                    const btn = document.getElementById(id);
                    btn.classList.remove('disabled-tab');
                    const limitBadge = btn.querySelector('.limit-badge');
                    if (limitBadge) limitBadge.remove();
                });
                
                // æ¢å¾©ã€Œäº’æ–¥é–å®šã€é‚è¼¯ (æª¢æŸ¥æ”å½±é¡å‹æ˜¯å¦å·²é¸)
                const photoType = document.getElementById('photo_type');
                if (photoType && photoType.value !== "") {
                    // å¦‚æœå·²ç¶“é¸äº†æ”å½±é¡å‹ï¼Œä¿æŒè—è¡“/å‹•æ¼«ç‚ºã€Œäº’æ–¥é–å®šã€ç‹€æ…‹
                    toggleLock('container-art', 'btn-art', true);
                    toggleLock('container-anime', 'btn-anime', true);
                } else {
                    // å¦å‰‡å…¨éƒ¨è§£é–
                    toggleLock('container-art', 'btn-art', false);
                    toggleLock('container-anime', 'btn-anime', false);
                }

            } else {
                // æœªç™»å…¥ï¼šé–å®š
                isLoggedIn = false;
                loginBtn.style.display = 'flex';
                userInfo.style.display = 'none';

                // åŠ ä¸Šé™åˆ¶
                restrictedTabs.forEach(id => {
                    const btn = document.getElementById(id);
                    btn.classList.add('disabled-tab');
                    if (!btn.querySelector('.limit-badge')) {
                        // æ’å…¥ "é™" å­—
                        btn.innerHTML = btn.innerHTML.replace(' <span class="limit-badge">é™</span>', '') + ' <span class="limit-badge">é™</span>';
                    }
                });

                // å¦‚æœç•¶å‰åœ¨é™åˆ¶åˆ†é ï¼Œå¼·åˆ¶è·³å›è¨­å®šé 
                const activeTab = document.querySelector('.nav-link.active');
                if (restrictedTabs.includes(activeTab.id)) {
                    switchTab(document.querySelector('.nav-link'), 'page-settings');
                }
            }
        });
    }

    // ==========================================
    //  ä¸»ç¨‹å¼é‚è¼¯
    // ==========================================
    let currentMode = 'create';
    const fontData = [{val: "Bold sans-serif", label: "ç²—é«”ç„¡è¥¯ç·š"}, {val: "Elegant serif", label: "å„ªé›…è¥¯ç·š"}, {val: "Handwritten script", label: "æ‰‹å¯«è‰æ›¸"}, {val: "Cyberpunk neon style", label: "è³½åšé¾å…‹éœ“è™¹"}, {val: "Vintage retro style", label: "å¾©å¤é¢¨æ ¼"}, {val: "Graffiti style", label: "å¡—é´‰é¢¨æ ¼"}, {val: "Calligraphy brush stroke", label: "æ›¸æ³•æ¯›ç­†"}, {val: "Pixel art style", label: "åƒç´ é¢¨æ ¼"}];

    const categorizedData = {
        "char": { 
            "æœè£ç©¿æ­": [{val: "T-shirt and jeans", label: "Tæ¤ç‰›ä»”è¤²"}, {val: "Suit and tie", label: "è¥¿è£"}, {val: "Evening gown", label: "æ™šç¦®æœ"}, {val: "Cyberpunk techwear", label: "æ©Ÿèƒ½é¢¨"}, {val: "Kimono", label: "å’Œæœ"}, {val: "School uniform", label: "åˆ¶æœ"}, {val: "Maid outfit", label: "å¥³åƒ•è£"}, {val: "Sportswear", label: "é‹å‹•æœ"}, {val: "Hoodie", label: "é€£å¸½è¡«"}, {val: "Armor", label: "ç›”ç”²"}],
            "é«®å‹é«®è‰²": [{val: "Long straight black hair", label: "é»‘é•·ç›´"}, {val: "Short bob cut", label: "é®‘ä¼¯é ­"}, {val: "Blonde ponytail", label: "é‡‘é«®é¦¬å°¾"}, {val: "Silver twin tails", label: "éŠ€é«®é›™é¦¬å°¾"}, {val: "Pink hair", label: "ç²‰é«®"}, {val: "Messy hair", label: "å‡Œäº‚é«®"}, {val: "Bald", label: "å…‰é ­"}, {val: "Curly hair", label: "æ²é«®"}],
            "äº”å®˜ç‰¹é»": [{val: "Blue eyes", label: "è—çœ¼"}, {val: "Red eyes", label: "ç´…çœ¼"}, {val: "Heterochromia", label: "ç•°è‰²ç³"}, {val: "Cat eyes", label: "è²“çœ¼"}, {val: "Wearing glasses", label: "çœ¼é¡"}, {val: "Freckles", label: "é›€æ–‘"}, {val: "Scar on face", label: "åˆ€ç–¤"}, {val: "Makeup", label: "åŒ–å¦"}],
            "è¡¨æƒ…": [{val: "Smile", label: "å¾®ç¬‘"}, {val: "Laughing", label: "å¤§ç¬‘"}, {val: "Crying", label: "å“­æ³£"}, {val: "Angry", label: "ç”Ÿæ°£"}, {val: "Expressionless", label: "ç„¡è¡¨æƒ…"}, {val: "Seductive", label: "èª˜æƒ‘"}, {val: "Surprised", label: "é©šè¨"}, {val: "Winking", label: "çœ¨çœ¼"}],
            "è‚¢é«”å‹•ä½œ": [{val: "Standing", label: "ç«™ç«‹"}, {val: "Sitting", label: "åè‘—"}, {val: "Lying", label: "èººè‘—"}, {val: "Running", label: "å¥”è·‘"}, {val: "Jumping", label: "è·³èº"}, {val: "Fighting stance", label: "æˆ°é¬¥å§¿å‹¢"}, {val: "Peace sign", label: "æ¯”YA"}, {val: "Looking back", label: "å›çœ¸"}],
            "é«”å‹": [{val: "Slim", label: "è‹—æ¢"}, {val: "Muscular", label: "è‚Œè‚‰"}, {val: "Curvy", label: "æ›²ç·š"}, {val: "Chubby", label: "è‚‰æ„Ÿ"}, {val: "Tall", label: "é«˜æŒ‘"}, {val: "Petite", label: "å¬Œå°"}]
        },
        "scene": { 
            "ç’°å¢ƒè¨­å®š": [{val: "Indoor", label: "å®¤å…§"}, {val: "Outdoor", label: "å®¤å¤–"}, {val: "Primitive Forest", label: "åŸå§‹æ£®æ—"}, {val: "Underwater", label: "æµ·åº•"}, {val: "Outer Space", label: "å¤ªç©º"}, {val: "Concert Stage", label: "æ¼”å”±æœƒ"}, {val: "Future City", label: "æœªä¾†åŸå¸‚"}],
            "ç‰¹å®šåœ°é»": [{val: "News Anchor Desk", label: "ä¸»æ’­å°"}, {val: "Church", label: "æ•™å ‚"}, {val: "Rooftop style of Infernal Affairs", label: "ç„¡é–“é“å¤©å°"}, {val: "Prison Cell", label: "ç›£ç„"}, {val: "Courtroom", label: "æ³•é™¢"}, {val: "Classroom", label: "æ•™å®¤"}, {val: "Cyberpunk Street", label: "è³½åšè¡—é“"}, {val: "Ancient Temple", label: "å¤å»Ÿ"}],
            "èƒŒæ™¯è™•ç†": [{val: "White Background", label: "ç™½èƒŒæ™¯"}, {val: "Simple Background", label: "ç°¡å–®èƒŒæ™¯"}, {val: "No Background", label: "ç„¡èƒŒæ™¯/å»èƒŒ"}, {val: "Green Screen", label: "ç¶ å¹•"}]
        },
        "photo": { 
            "æ”å½±é¡å‹": [{id: "photo_type", val: "photo", label: "ç…§ç‰‡"}, {id: "photo_type", val: "portrait photography", label: "äººåƒ"}, {id: "photo_type", val: "life photo", label: "ç”Ÿæ´»ç…§"}, {id: "photo_type", val: "sports photography", label: "é‹å‹•"}, {id: "photo_type", val: "still life photo", label: "éœç‰©"}, {id: "photo_type", val: "selfie photo", label: "è‡ªæ‹"}],
            "å…‰åœˆ": [{id:"photo_aperture", val:"f/1.4", label:"f/1.4"}, {id:"photo_aperture", val:"f/2.8", label:"f/2.8"}, {id:"photo_aperture", val:"f/8", label:"f/8"}, {id:"photo_aperture", val:"f/16", label:"f/16"}, {id:"photo_aperture", val:"f/32", label:"f/32"}],
            "ç„¦è·": [{id:"photo_focal", val:"20mm", label:"20mm (è¶…å»£)"}, {id:"photo_focal", val:"35mm", label:"35mm (äººæ–‡)"}, {id:"photo_focal", val:"85mm", label:"85mm (äººåƒ)"}, {id:"photo_focal", val:"200mm", label:"200mm (æœ›é )"}, {id:"photo_focal", val:"macro lens", label:"å¾®è·é¡é ­"}, {id:"photo_focal", val:"fish eye lens", label:"é­šçœ¼"}],
            "é¢¨æ ¼": [{val:"DSLR style", label:"æ•¸ä½å–®çœ¼"}, {val:"Polaroid style", label:"æ‹ç«‹å¾—"}, {val:"gopro style", label:"GoPro"}, {val:"Fujifilm superia style", label:"å¯Œå£«åº•ç‰‡"}, {val:"LOMO style", label:"LOMO"}, {val:"movie style", label:"é›»å½±é¢¨"}, {val:"cinematic photo style", label:"åŠ‡ç…§"}, {val:"vintage photo style", label:"å¾©å¤"}, {val:"Holga photography", label:"Holga"}, {val:"Anthotype print", label:"æ¤ç‰©æ„Ÿå…‰"}],
            "å…‰å½±èˆ‡æ•ˆæœ": [{val:"bokeh", label:"æ•£æ™¯"}, {val:"lens flare", label:"é¡é ­çœ©å…‰"}, {val:"magic hour", label:"é­”å¹»æ™‚åˆ»"}, {val:"golden hour", label:"é»ƒé‡‘æ™‚åˆ»"}, {val:"blue hour", label:"è—è‰²æ™‚åˆ»"}, {val:"ambient light", label:"ç’°å¢ƒå…‰"}, {val:"hard light", label:"ç¡¬å…‰"}, {val:"soft light", label:"æŸ”å…‰"}, {val:"back light", label:"èƒŒå…‰"}, {val:"HDR", label:"HDR"}, {val:"double exposure", label:"é‡è¤‡æ›å…‰"}, {val:"motion blur", label:"å‹•æ…‹æ¨¡ç³Š"}],
            "ç•«é¢è§’åº¦": [{val:"face close-up", label:"è‡‰éƒ¨ç‰¹å¯«"}, {val:"full body shot", label:"å…¨èº«ç…§"}, {val:"low angle view", label:"ä½è§’åº¦"}, {val:"high angle view", label:"é«˜è§’åº¦"}, {val:"bird view", label:"é³¥ç°"}, {val:"knolling", label:"é–‹ç®±ç…§/å¹³é‹ª"}, {val:"product view", label:"ç”¢å“ç‰¹å¯«"}, {val:"360 degrees photo", label:"360åº¦"}, {val:"X-ray view", label:"Xå…‰ç‰‡"}]
        },
        "art": { 
            "ç¹ªç•«åª’æ": [{val:"illustration", label:"æ’ç•«"}, {val:"pencil", label:"é‰›ç­†"}, {val:"charcoal", label:"ç‚­ç­†"}, {val:"color pencil", label:"è‰²é‰›ç­†"}, {val:"acrylic painting", label:"å£“å…‹åŠ›"}, {val:"watercolor painting", label:"æ°´å½©"}, {val:"oil painting", label:"æ²¹ç•«"}, {val:"ink drawing", label:"æ°´å¢¨"}, {val:"Woodcut", label:"ç‰ˆç•«"}, {val:"vector art", label:"å‘é‡åœ–"}],
            "æè³ª": [{val:"paper art", label:"ç´™é›•"}, {val:"origami art", label:"æ‘ºç´™"}, {val:"stained glass", label:"å½©ç¹ªç»ç’ƒ"}, {val:"mosaic", label:"é¦¬è³½å…‹"}, {val:"pixel art", label:"åƒç´ ç•«"}, {val:"Low poly", label:"ä½å¤šé‚Šå½¢"}, {val:"wood carving", label:"æœ¨é›•"}, {val:"lego", label:"æ¨‚é«˜"}, {val:"felt doll", label:"ç¾Šæ¯›æ°ˆ"}, {val:"neon light", label:"éœ“è™¹ç‡ˆ"}],
            "æµæ´¾": [{val:"Impressionnisme", label:"å°è±¡æ´¾"}, {val:"Surrealism", label:"è¶…ç¾å¯¦"}, {val:"Cubism", label:"ç«‹é«”ä¸»ç¾©"}, {val:"Pop Art", label:"æ™®æ™®"}, {val:"Minimalism", label:"æ¥µç°¡"}, {val:"Cyber Art", label:"è³½åšè—è¡“"}, {val:"Steampunk", label:"è’¸æ°£é¾å…‹"}, {val:"Ukiyo-e", label:"æµ®ä¸–ç¹ª"}, {val:"Baroque art", label:"å·´æ´›å…‹"}],
            "è—è¡“å®¶": [{val:"Vincent van Gogh", label:"æ¢µè°·"}, {val:"Leonardo da Vinci", label:"é”æ–‡è¥¿"}, {val:"Picasso", label:"ç•¢å¡ç´¢"}, {val:"Dali", label:"é”åˆ©"}, {val:"Monet", label:"è«å…§"}, {val:"Mucha", label:"æ…•å¤"}, {val:"Andy Warhol", label:"å®‰è¿ªæ²ƒè·"}, {val:"Hayao Miyazaki", label:"å®®å´é§¿"}, {val:"Makoto Shinkai", label:"æ–°æµ·èª "}, {val:"Yayoi Kusama", label:"è‰é–“å½Œç”Ÿ"}]
        },
        "anime": { 
            "ä½œå“": [{val: "One Piece style", label: "èˆªæµ·ç‹"}, {val: "Detective Conan style", label: "ååµæ¢æŸ¯å—"}, {val: "Naruto style", label: "ç«å½±å¿è€…"}, {val: "Slam Dunk style", label: "çŒç±ƒé«˜æ‰‹"}, {val: "style of Mitsuru Adachi", label: "å®‰é”å……é¢¨æ ¼"}, {val: "Fist of the North Star style", label: "åŒ—æ–—ç¥æ‹³"}, {val: "Saint Seiya style", label: "è–é¬¥å£«æ˜ŸçŸ¢"}, {val: "A Certain Scientific Railgun style", label: "æŸç§‘å­¸çš„è¶…é›»ç£ç ²"}, {val: "Studio Ghibli style", label: "å‰åœåŠ›"}, {val: "Dragon ball style", label: "ä¸ƒé¾ç "}, {val: "Sailor Moon style", label: "ç¾å°‘å¥³æˆ°å£«"}, {val: "JoJo style", label: "JoJo"}],
            "é¡å‹èˆ‡å…¬å¸": [{val:"2D cartoon", label:"2D å¡é€š"}, {val:"3D cartoon", label:"3D å¡é€š"}, {val:"American comic book", label:"ç¾å¼æ¼«ç•«"}, {val:"Manga", label:"æ—¥å¼æ¼«ç•«"}, {val:"Pixar Animation", label:"çš®å…‹æ–¯"}, {val:"Disney Animation", label:"è¿ªå£«å°¼"}, {val:"Kyoto Animation", label:"äº¬éƒ½å‹•ç•«"}, {val:"Marvel Animation", label:"æ¼«å¨"}],
            "è¨­è¨ˆ": [{val:"mascot logo", label:"å‰ç¥¥ç‰© Logo"}, {val:"UI design", label:"UI ä»‹é¢"}, {val:"3D Model Exploded View", label:"3D åˆ†è§£åœ–"}, {val:"2D floor plan", label:"2D å¹³é¢åœ–"}, {val:"character toy", label:"å…¬ä»”ç©å…·"}]
        }
    };

    function init() {
        const fontSelect = document.getElementById('textFont');
        fontSelect.appendChild(new Option("ä¸æŒ‡å®š", ""));
        fontData.forEach(item => fontSelect.appendChild(new Option(item.label, item.val)));

        for (const [tabKey, categories] of Object.entries(categorizedData)) {
            const container = document.getElementById(`container-${tabKey}`);
            if (!container) continue;
            for (const [catName, items] of Object.entries(categories)) {
                const card = document.createElement('div'); card.className = 'category-card';
                const label = document.createElement('label'); label.className = 'category-title'; label.textContent = catName;
                card.appendChild(label);
                const select = document.createElement('select'); select.className = 'form-select category-select';
                if (items.length > 0 && items[0].id) select.id = items[0].id;
                select.appendChild(new Option("ä¸æŒ‡å®š", ""));
                items.forEach(item => select.appendChild(new Option(item.label, item.val)));
                card.appendChild(select);
                container.appendChild(card);
            }
        }
        
        // æ”å½±äº’æ–¥é‚è¼¯
        const photoType = document.getElementById('photo_type');
        if (photoType) {
            photoType.addEventListener('change', function() {
                if (!isLoggedIn) return; // æœªç™»å…¥ä¸è™•ç†ï¼Œå› ç‚ºæœ¬ä¾†å°±é–ä½äº†
                
                const isPhoto = this.value !== "";
                ['photo_aperture', 'photo_focal'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) { el.disabled = !isPhoto; if(!isPhoto) el.value=""; }
                });
                toggleLock('container-art', 'btn-art', isPhoto);
                toggleLock('container-anime', 'btn-anime', isPhoto);
            });
        }
        ['photo_aperture', 'photo_focal'].forEach(id => { const el = document.getElementById(id); if(el) el.disabled = true; });
        
        setMode('create');
    }

    function toggleLock(cid, bid, lock) {
        // é€™å€‹å‡½å¼ç¾åœ¨ä¸»è¦ç”¨æ–¼ã€Œæ”å½±äº’æ–¥ã€ï¼Œæ¬Šé™é–å®šç”± Firebase Auth Listener æ§åˆ¶
        if (!isLoggedIn) return; // å¦‚æœæ²’ç™»å…¥ï¼Œå…¨éƒ¨äº¤çµ¦ Auth Listener æ§åˆ¶

        const c = document.getElementById(cid), b = document.getElementById(bid);
        c.querySelectorAll('select').forEach(s => { s.disabled = lock; if(lock) s.value=""; });
        
        // åªæœ‰åœ¨äº’æ–¥é‚è¼¯ä¸‹ï¼Œæ‰é¡¯ç¤ºã€Œé–ã€å­—ï¼Œä¸å½±éŸ¿ã€Œé™ã€å­—
        b.querySelector('.locked-badge').style.display = lock ? 'inline-block' : 'none';
        
        // è¦–è¦ºè®Šç°ï¼Œä½†ä¸å½±éŸ¿ç™»å…¥é™åˆ¶çš„ç´…è‰²ã€Œé™ã€
        b.classList.toggle('disabled-tab', lock); 
        c.querySelectorAll('.category-card').forEach(card => card.classList.toggle('disabled-card', lock));
    }

    // --- æ¬Šé™åˆ¤æ–·é»é¸ ---
    function switchTab(btn, targetId) {
        // å¦‚æœæ˜¯æŒ‰åˆ°äº†è¢«æ¬Šé™é–ä½(limit-badge)çš„æŒ‰éˆ•ï¼Œæˆ–è€…æ˜¯è¢«äº’æ–¥é–ä½(locked-badge)çš„æŒ‰éˆ•
        if (btn.classList.contains('disabled-tab')) {
            if (btn.querySelector('.limit-badge')) {
                alert("ğŸ”’ æœƒå“¡é™å®šåŠŸèƒ½\n\nè«‹é»é¸å³ä¸Šè§’ã€Œç™»å…¥ã€Google å¸³è™Ÿä»¥è§£é–æ­¤åŠŸèƒ½ï¼");
            } else if (btn.querySelector('.locked-badge') && btn.querySelector('.locked-badge').style.display !== 'none') {
                alert("âš ï¸ æ¨¡å¼è¡çª\n\næ‚¨å·²é¸æ“‡ã€Œæ”å½±é¡å‹ã€ï¼Œå› æ­¤ç„¡æ³•åŒæ™‚é¸æ“‡è—è¡“/å‹•æ¼«é¢¨æ ¼ã€‚\nè«‹å…ˆå°‡æ”å½±é¡å‹è¨­ç‚ºã€Œä¸æŒ‡å®šã€å³å¯è§£é–ã€‚");
            }
            return;
        }

        document.querySelectorAll('.nav-link').forEach(b => {
            b.classList.remove('active'); b.style.backgroundColor='#f8f9fa'; b.style.color='#6c757d';
        });
        btn.classList.add('active'); btn.style.backgroundColor='#4285f4'; btn.style.color='white';
        document.querySelectorAll('.tab-content-area').forEach(div => div.classList.remove('active'));
        document.getElementById(targetId).classList.add('active');
    }

    // (å…¶é¤˜åŠŸèƒ½å‡½å¼ä¿æŒä¸è®Š)
    function setMode(mode) {
        currentMode = mode;
        const els = ['inputRow', 'btnRandom', 'myTab'];
        const isReverse = mode === 'reverse';
        document.getElementById('mode-create').classList.toggle('active', !isReverse);
        document.getElementById('mode-reverse').classList.toggle('active', isReverse);
        els.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = isReverse ? 'none' : (id === 'inputRow' || id === 'myTab' ? 'flex' : 'block');
        });
        const hint = document.getElementById('mode-hint');
        const genBtn = document.getElementById('generateBtn');
        if (isReverse) {
            switchTab(document.querySelector('.nav-link'), 'page-settings');
            hint.innerHTML = `<div style="background: #f3e5f5; padding: 10px; border-radius: 8px; color: #6a1b9a;"><strong>ğŸ”® åæ¨æç¤ºè©æ¨¡å¼</strong><br>1. æŒ‰ã€Œä¸Šå‚³åœ–ç‰‡ã€ã€‚<br>2. æŒ‰ç”¢å‡ºï¼Œè¤‡è£½æŒ‡ä»¤ã€‚<br>3. åœ¨ Gemini è²¼ä¸Šæ–‡å­—ä¸¦<b>ä¸Šå‚³åœ–ç‰‡</b>ã€‚</div>`;
            genBtn.textContent = "ğŸ” ç”¢å‡ºåˆ†ææŒ‡ä»¤";
            genBtn.style.backgroundColor = "#8e24aa";
            genBtn.style.borderColor = "#8e24aa";
        } else {
            hint.innerHTML = "";
            genBtn.textContent = "âœ¨ ç”¢å‡ºç¹ªåœ–æŒ‡ä»¤";
            genBtn.style.backgroundColor = "#4285f4";
            genBtn.style.borderColor = "#4285f4";
        }
    }

    function autoRandomize() {
        if (currentMode === 'reverse') return;
        let activeTabId = document.querySelector('.tab-content-area.active').id;
        
        // æª¢æŸ¥éš¨æ©Ÿç›®æ¨™æ˜¯å¦è¢«é–å®š
        if (['page-photo', 'page-art', 'page-anime'].includes(activeTabId)) {
             const currentBtn = document.querySelector(`.nav-link[onclick*='${activeTabId}']`);
             if (currentBtn && currentBtn.classList.contains('disabled-tab')) {
                 alert("æ­¤å€åŸŸå°šæœªè§£é–ï¼Œç„¡æ³•éš¨æ©Ÿç”¢ç”Ÿå–”ï¼");
                 return;
             }
        }

        let targetContainer = "";
        if (activeTabId === 'page-settings' || activeTabId === 'page-text') {
            switchTab(document.querySelectorAll('.nav-link')[3], 'page-char'); // æ”¹è·³äººç‰©
            targetContainer = 'container-char';
        } else {
            targetContainer = activeTabId.replace('page-', 'container-');
        }
        const container = document.getElementById(targetContainer);
        if (!container) return;
        let changedCount = 0;
        container.querySelectorAll('select.category-select').forEach(select => {
            if (select.disabled) return;
            const options = select.options;
            if (options.length > 1) {
                select.selectedIndex = Math.floor(Math.random() * (options.length - 1)) + 1;
                select.dispatchEvent(new Event('change'));
                changedCount++;
            }
        });
        if (activeTabId === 'page-text') {
             const sampleTexts = ["Hello World", "Gemini AI", "Creative Mode", "ä¿æŒå¥½å¥‡", "æ—©å®‰"];
             const samplePositions = ["Top left", "Bottom right, glowing", "Centered, floating"];
             document.getElementById('textContent').value = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
             document.getElementById('textPosition').value = samplePositions[Math.floor(Math.random() * samplePositions.length)];
             changedCount++;
        }
        if (changedCount > 0) {
            generatePrompt();
            const btn = document.getElementById('btnRandom');
            const originalText = btn.textContent;
            btn.textContent = "âœ…";
            setTimeout(() => btn.textContent = originalText, 1000);
        }
    }

    function triggerNativeCamera() { document.getElementById('cameraInput').click(); }
    
    function handleImageSelect(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('finalImage').src = e.target.result;
                document.getElementById('previewBox').style.display = 'block';
                if (currentMode === 'create') {
                    const subj = document.getElementById('mainSubject');
                    if (!subj.value.trim()) subj.value = "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]";
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function clearPhoto() {
        document.getElementById('finalImage').src = "";
        document.getElementById('previewBox').style.display = 'none';
        document.getElementById('cameraInput').value = "";
        const input = document.getElementById('mainSubject');
        if (input.value === "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]") input.value = "";
    }

    async function generatePrompt() {
        const aspectRatio = document.getElementById('aspectRatio').value;
        const pixelRes = document.getElementById('pixelResolution').value;
        const hasPhoto = document.getElementById('finalImage').getAttribute('src') !== "";
        const txtContent = document.getElementById('textContent').value.trim();
        const txtPosition = document.getElementById('textPosition').value.trim();
        const txtFont = document.getElementById('textFont').value;
        let parts = [];

        if (currentMode === 'reverse') {
            if (!hasPhoto) { alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼"); return; }
            parts.push("You are an expert Prompt Engineer.");
            parts.push("Please analyze the attached image in extreme detail.");
            parts.push("Provide a comprehensive text prompt that could generate this exact image.");
            parts.push("Output format: A single, high-quality descriptive paragraph in English.");
        } else {
            let mainSubject = document.getElementById('mainSubject').value.trim();
            const btn = document.getElementById('generateBtn');
            if (/[\u4e00-\u9fa5]/.test(mainSubject) && mainSubject !== "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]") {
                const originalText = btn.textContent;
                btn.textContent = "â³ ç¿»è­¯ä¸­...";
                btn.disabled = true;
                mainSubject = await translateInput() || mainSubject;
                btn.textContent = originalText;
                btn.disabled = false;
            }
            if (hasPhoto) {
                parts.push("INSTRUCTION: Analyze the attached image deeply.");
                parts.push("1. Identify the pose, composition, and main elements.");
                if (mainSubject && mainSubject !== "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]") {
                    parts.push(`2. Modification Request: Transform the subject into: ${mainSubject}.`);
                } else {
                    parts.push("2. Recreate this image maintaining the original composition.");
                }
            } else {
                parts.push("Generate an image with the following description:");
                if (mainSubject) parts.push(`Subject: ${mainSubject}.`);
            }
            if (txtContent) {
                 parts.push(`INSTRUCTION: Insert text into the image.`);
                 parts.push(`Text Content: "${txtContent}".`);
                 if (txtPosition) parts.push(`Text Position: ${txtPosition}.`);
                 if (txtFont) parts.push(`Font Style: ${txtFont}.`);
            }
            let details = [];
            document.querySelectorAll('.category-select').forEach(select => {
                if (select.value && !select.disabled && select.id !== 'aspectRatio' && select.id !== 'pixelResolution' && select.id !== 'textFont') {
                    details.push(select.value);
                }
            });
            if (details.length > 0) parts.push(`Details, Scene & Style: ${details.join(', ')}.`);
            if (pixelRes) parts.push(`Quality/Resolution: ${pixelRes}.`);
            if (aspectRatio) parts.push(`Aspect Ratio: ${aspectRatio}.`);
            parts.push("Ensure the output is highly detailed and aesthetically pleasing.");
        }
        document.getElementById('outputPrompt').value = parts.join(' ');
    }

    async function translateInput() {
        const text = document.getElementById('mainSubject').value.trim();
        try {
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh-TW|en`);
            const data = await res.json();
            return data.responseData?.translatedText;
        } catch (e) { return text; }
    }

    function copyToClipboard() {
        const el = document.getElementById("outputPrompt");
        el.select(); navigator.clipboard.writeText(el.value);
    }

    init();
    if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
</script>
</body>
</html>


