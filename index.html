<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ICS Prompt Lab Pro - V5.7 Fixed</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = { darkMode: 'media' }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; transition: background-color 0.4s ease; }
        .app-card { border-radius: 32px; transition: all 0.3s ease; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-active { @apply text-indigo-600 dark:text-indigo-400 font-black; }
        .gradient-header { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        @media (prefers-color-scheme: dark) {
            body { background-color: #0f172a; }
        }
        canvas { max-width: 100%; height: auto; cursor: crosshair; touch-action: none; background: #f8fafc; }
        input:checked ~ .dot { transform: translateX(100%); background-color: #4f46e5; }
        @keyframes dice-roll { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .rolling { animation: dice-roll 0.5s ease-in-out; }
    </style>
</head>
<body class="p-4 bg-slate-50 dark:bg-slate-900 min-h-screen font-sans pb-28">

    <div class="w-full max-w-md mx-auto bg-white dark:bg-slate-800 app-card shadow-2xl overflow-hidden border border-gray-100 dark:border-slate-700">
        
        <div id="genTab" class="tab-content active">
            <div class="p-8 gradient-header text-white relative">
                <h1 class="text-3xl font-black flex items-center gap-3 relative z-10">
                    <i class="fas fa-magic text-yellow-300"></i> ICS Lab
                </h1>
                <p class="text-indigo-100 text-[10px] mt-2 font-bold tracking-[0.3em] opacity-90 uppercase relative z-10">V5.7 Final Edition</p>
                <button onclick="randomSurprise()" class="absolute bottom-6 right-6 bg-white/20 hover:bg-white/30 backdrop-blur-md p-3 rounded-2xl border border-white/30 transition-all active:scale-90">
                    <i id="diceIcon" class="fas fa-dice text-2xl text-white"></i>
                </button>
            </div>

            <div class="p-6 space-y-7">
                <section>
                    <label class="text-[10px] font-black text-indigo-500 mb-3 block tracking-[0.2em] uppercase">Step 01. åœ–ç‰‡é¡å‹</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-infographic" onclick="vibrate(); setType('infographic', this)" class="type-btn ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/40 p-3 rounded-2xl text-indigo-700 dark:text-indigo-300 text-xs font-bold transition-all">è³‡è¨Šåœ–è¡¨</button>
                        <button id="btn-diagram" onclick="vibrate(); setType('diagram', this)" class="type-btn border border-gray-100 dark:border-slate-700 p-3 rounded-2xl text-gray-500 dark:text-slate-400 text-xs font-medium transition-all">åŠŸèƒ½åœ–è§£</button>
                        <button id="btn-flowchart" onclick="vibrate(); setType('flowchart', this)" class="type-btn border border-gray-100 dark:border-slate-700 p-3 rounded-2xl text-gray-500 dark:text-slate-400 text-xs font-medium transition-all">æµç¨‹åœ–</button>
                        <button id="btn-timeline" onclick="vibrate(); setType('timeline', this)" class="type-btn border border-gray-100 dark:border-slate-700 p-3 rounded-2xl text-gray-500 dark:text-slate-400 text-xs font-medium transition-all">æ™‚é–“è»¸</button>
                    </div>
                </section>

                <section>
                    <label class="text-[10px] font-black text-indigo-500 mb-3 block tracking-[0.2em] uppercase">Step 02. å…§å®¹ä¸»é¡Œ</label>
                    <textarea id="content" rows="2" placeholder="è¼¸å…¥ä½ æƒ³å‘ˆç¾çš„ä¸»é¡Œ..." class="w-full p-4 bg-gray-50 dark:bg-slate-900/50 border border-gray-100 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none text-gray-700 dark:text-slate-200 transition-all text-sm"></textarea>
                </section>

                <section>
                    <label class="text-[10px] font-black text-indigo-500 mb-3 block tracking-[0.2em] uppercase">Step 03. è¦–è¦ºé¢¨æ ¼ (32ç¨®)</label>
                    <select id="style" onchange="vibrate(); updatePreview()" class="w-full p-4 bg-gray-50 dark:bg-slate-900/50 border border-gray-100 dark:border-slate-700 rounded-2xl font-bold text-gray-700 dark:text-slate-200 mb-3 outline-none text-sm appearance-none shadow-sm">
                        <option value="" disabled selected>è«‹é¸æ“‡é¢¨æ ¼...</option>
                        <optgroup label="ğŸ’¼ å°ˆæ¥­å•†å‹™">
                            <option value="McKinsey">01 é¡§å•é¢¨ McKinsey</option>
                            <option value="Corporate">02 ä¼æ¥­é¢¨ Corporate</option>
                            <option value="Minimalist">03 æ¥µç°¡é¢¨ Minimalist</option>
                            <option value="Professional">04 ç°¡å ±é¢¨ Professional</option>
                            <option value="Framework">05 åœ–è¡¨é¢¨ Framework</option>
                        </optgroup>
                        <optgroup label="ğŸ¨ æ’ç•«è—è¡“">
                            <option value="Watercolor">06 æ°´å½©é¢¨ Watercolor</option>
                            <option value="Isometric 3D">07 ç­‰è·é¢¨ Isometric 3D</option>
                            <option value="Flat Vector">08 æ‰å¹³é¢¨ Flat Vector</option>
                            <option value="Kawaii">09 å¯æ„›é¢¨ Kawaii</option>
                            <option value="Hand-drawn Sketch">10 æ‰‹ç¹ªé¢¨ Hand-drawn</option>
                            <option value="Paper Cutout">11 å‰ªç´™é¢¨ Paper Cutout</option>
                        </optgroup>
                        <optgroup label="ğŸ® è¶£å‘³å‰µæ„">
                            <option value="Anime">12 å‹•æ¼«é¢¨ Anime</option>
                            <option value="Comic Book">13 æ¼«ç•«é¢¨ Comic Book</option>
                            <option value="Pixel Art">14 åƒç´ é¢¨ Pixel Art</option>
                            <option value="Claymation">15 é»åœŸé¢¨ Claymation</option>
                            <option value="Origami">16 æ‘ºç´™é¢¨ Origami</option>
                            <option value="Graffiti">17 å¡—é´‰é¢¨ Graffiti</option>
                        </optgroup>
                        <optgroup label="ğŸ“œ å¾©å¤ç¶“å…¸">
                            <option value="Vintage Poster">18 æµ·å ±é¢¨ Vintage</option>
                            <option value="Chalkboard">19 é»‘æ¿é¢¨ Chalkboard</option>
                            <option value="Analog Film">20 åº•ç‰‡é¢¨ Analog Film</option>
                            <option value="Pop Art">21 æ™®æ™®é¢¨ Pop Art</option>
                            <option value="Da Vinci">22 é”æ–‡è¥¿ Da Vinci</option>
                        </optgroup>
                        <optgroup label="ğŸ”¬ æŠ€è¡“åœ–è§£">
                            <option value="Blueprint">23 è—åœ–é¢¨ Blueprint</option>
                            <option value="Cross-section">24 å‰–é¢åœ– Cross-section</option>
                            <option value="Wireframe">25 ç·šæ¡†åœ– Wireframe</option>
                            <option value="Subway Map">26 åœ°éµåœ– Subway Map</option>
                        </optgroup>
                        <optgroup label="âœ¨ ç‰¹æ®Šé¢¨æ ¼">
                            <option value="Cyberpunk">27 è³½åšé¾å…‹ Cyberpunk</option>
                            <option value="Steampunk">28 è’¸æ°£é¾å…‹ Steampunk</option>
                            <option value="Quilling">29 ç´™é›•é¢¨ Quilling</option>
                            <option value="Flat Lay">30 æ”å½±é¢¨ Flat Lay</option>
                            <option value="Glassmorphism">31 ç»ç’ƒé¢¨ Glassmorphism</option>
                            <option value="Diorama">32 å°å±‹é¢¨ Diorama</option>
                        </optgroup>
                    </select>
                    <div id="previewCard" class="hidden p-4 rounded-2xl bg-indigo-50 dark:bg-slate-900 border border-indigo-100 dark:border-slate-700">
                        <p id="previewText" class="text-xs text-gray-500 dark:text-slate-400 leading-relaxed font-medium"></p>
                    </div>
                </section>

                <button onclick="vibrate(); generate()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-xl transition-all active:scale-95 flex justify-center items-center gap-2 text-lg">
                    ç”ŸæˆæŒ‡ä»¤ <i class="fas fa-magic"></i>
                </button>

                <div id="resultBox" class="hidden animate-in zoom-in-95 duration-300">
                    <div class="bg-slate-900 rounded-[2rem] p-6 border border-slate-700 shadow-2xl">
                        <p id="finalPrompt" class="text-indigo-200 text-xs font-mono whitespace-pre-line leading-relaxed bg-slate-950 p-4 rounded-xl border border-white/5 mb-6"></p>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="vibrate(); copyText()" class="bg-indigo-600 text-white p-3 rounded-xl text-xs font-bold flex flex-col items-center gap-1"><i class="far fa-copy"></i> è¤‡è£½</button>
                            <button onclick="vibrate(); shareLine()" class="bg-[#06C755] text-white p-3 rounded-xl text-xs font-bold flex flex-col items-center gap-1"><i class="fab fa-line text-xl"></i></button>
                            <button onclick="vibrate(); shareFB()" class="bg-[#1877F2] text-white p-3 rounded-xl text-xs font-bold flex flex-col items-center gap-1"><i class="fab fa-facebook text-xl"></i></button>
                        </div>
                    </div>
                </div>

                <section id="historySection" class="pt-4 pb-10">
                    <div class="flex items-center justify-between mb-3 px-1">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">æ­·å²ç´€éŒ„ (5ç­†)</label>
                        <button onclick="vibrate(); clearHistory()" class="text-[10px] font-bold text-indigo-500">æ¸…é™¤</button>
                    </div>
                    <div id="historyList" class="space-y-2"></div>
                </section>
            </div>
        </div>

        <div id="repairTab" class="tab-content">
            <div class="p-8 bg-slate-800 text-white">
                <h1 class="text-2xl font-black italic text-indigo-400 uppercase">Repair Master</h1>
                <p class="text-[10px] tracking-widest opacity-60 uppercase mt-1">ä¸­æ–‡å­—é«”ç„¡æä¿®å¾©å¼•æ“</p>
            </div>
            <div class="p-6 space-y-6">
                <div id="uploadArea" class="border-2 border-dashed border-slate-200 rounded-3xl p-10 text-center" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-image text-4xl text-indigo-500 mb-3"></i>
                    <p class="text-xs font-bold text-gray-500">é»æ“Šä¸Šå‚³åœ–æª”</p>
                    <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="loadImage(this)">
                </div>
                <div id="editorArea" class="hidden space-y-4">
                    <canvas id="mainCanvas" class="rounded-2xl shadow-inner border border-gray-200"></canvas>
                    <div class="grid grid-cols-2 gap-3 p-4 bg-gray-50 dark:bg-slate-900 rounded-2xl border">
                        <div>
                            <label class="text-[9px] font-black text-gray-400 uppercase block mb-1">å¤§å°: <span id="sizeVal">28</span>px</label>
                            <input type="range" id="fontSize" min="10" max="100" value="28" oninput="document.getElementById('sizeVal').innerText=this.value" class="w-full">
                        </div>
                        <div>
                            <label class="text-[9px] font-black text-gray-400 uppercase block mb-1">å­—é«”</label>
                            <select id="fontFamily" class="w-full text-xs p-1.5 rounded-lg border">
                                <option value="sans-serif">æ¨™æº–é»‘é«”</option>
                                <option value="serif">ç¶“å…¸å®‹é«”</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[9px] font-black text-gray-400 uppercase block mb-1">é¡è‰²</label>
                            <input type="color" id="textColor" value="#333333" class="w-full h-8 cursor-pointer">
                        </div>
                    </div>
                    <button onclick="downloadImage()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black">ä¸‹è¼‰ä¿®å¾©åœ–</button>
                </div>
            </div>
        </div>
    </div>

    <div id="textOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-6">
        <div class="bg-white dark:bg-slate-800 rounded-3xl p-6 w-full max-w-xs space-y-4">
            <h3 class="font-bold text-gray-800 dark:text-white">è«‹è¼¸å…¥æ­£ç¢ºæ–‡å­—</h3>
            <input type="text" id="correctText" class="w-full p-4 bg-gray-100 dark:bg-slate-900 rounded-xl text-xl text-center font-bold outline-none text-gray-700 dark:text-white" autofocus>
            <div class="flex gap-2">
                <button onclick="applyText()" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-bold">ä¿®å¾©</button>
                <button onclick="closeOverlay()" class="flex-1 bg-gray-200 text-gray-500 py-4 rounded-xl font-bold">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl border border-white/20 shadow-2xl rounded-3xl p-2 flex justify-around items-center z-50">
        <button onclick="switchTab('genTab', this)" class="nav-btn nav-active flex flex-col items-center p-2">
            <i class="fas fa-magic text-xl"></i>
            <span class="text-[10px] mt-1 font-bold">æŒ‡ä»¤ç”Ÿæˆ</span>
        </button>
        <button onclick="switchTab('repairTab', this)" class="nav-btn text-gray-400 flex flex-col items-center p-2">
            <i class="fas fa-tools text-xl"></i>
            <span class="text-[10px] mt-1 font-bold">åœ–åƒä¿®å¾©</span>
        </button>
    </nav>

    <script>
        // ------------------ å®Œæ•´ 32 ç¨®é¢¨æ ¼å­—å…¸ ------------------
        const styleSpecs = {
            "McKinsey": { spec: "Professional business framework, corporate blue.", desc: "é¡§å•å°ˆæ¥­é¢¨ï¼šç¶“å…¸å•†å‹™è—ï¼Œå¼·èª¿æ•¸æ“šé‚è¼¯ã€‚" },
            "Corporate": { spec: "Modern office aesthetic, polished branding.", desc: "ä¼æ¥­è³ªæ„Ÿé¢¨ï¼šé©åˆç§‘æŠ€ç”¢å“ä»‹ç´¹ã€‚" },
            "Minimalist": { spec: "Clean white space, high contrast.", desc: "æ¥µç°¡ç¾å­¸ï¼šå¤§é‡ç•™ç™½ï¼Œè¦–è¦ºç„¦é»é›†ä¸­ã€‚" },
            "Professional": { spec: "Clean slide design, balanced typography.", desc: "å°ˆæ¥­ç°¡å ±ï¼šæ’ç‰ˆè¦æ•´ï¼Œé©åˆå·¥ä½œå ±å‘Šã€‚" },
            "Framework": { spec: "Logical flow, systematic arrangement.", desc: "é‚è¼¯æ¡†æ¶ï¼šæ¸…æ™°çš„æ¨¡çµ„åŒ–æ’ç‰ˆã€‚" },
            "Watercolor": { spec: "Soft watercolor wash, artistic edges.", desc: "æ‰‹ç¹ªæ°´å½©ï¼šæµªæ¼«ä¸”å…·è—è¡“æ„Ÿçš„ç­†è§¸ã€‚" },
            "Isometric 3D": { spec: "30-degree isometric, cubic shapes.", desc: "ç­‰è·è¦–è§’ï¼šç«‹é«”å †ç–Šï¼Œç§‘æŠ€æ„Ÿå¼·ã€‚" },
            "Flat Vector": { spec: "2D flat design, bold colors.", desc: "æ‰å¹³æ’ç•«ï¼šç°¡æ½”æ˜äº®ï¼Œé©åˆç¶²é è¨­è¨ˆã€‚" },
            "Kawaii": { spec: "Cute characters, pastel colors.", desc: "å¯æ„›æ’ç•«ï¼šç²‰è‰²èª¿ã€åœ“æ½¤è¦ªå’Œã€‚" },
            "Hand-drawn Sketch": { spec: "Pencil line texture, rough edges.", desc: "è‰åœ–æ‰‹å¯«ï¼šè¦ªåˆ‡è‡ªç„¶å…·æº«åº¦ã€‚" },
            "Paper Cutout": { spec: "Layered paper, drop shadows.", desc: "å±¤æ¬¡å‰ªç´™ï¼šç«‹é«”æ‰‹å·¥è³ªæ„Ÿã€‚" },
            "Anime": { spec: "High-quality anime art, vibrant.", desc: "ç²¾ç¾å‹•æ¼«ï¼šè§’è‰²å……æ»¿æ´»åŠ›ã€‚" },
            "Comic Book": { spec: "Bold lines, halftone dots.", desc: "ç¾å¼æ¼«ç•«ï¼šè¦–è¦ºå¼µåŠ›åè¶³ã€‚" },
            "Pixel Art": { spec: "16-bit retro, pixel grid.", desc: "åƒç´ è—è¡“ï¼šæ‡·èˆŠéŠæˆ²æ•¸ä½ç¾ã€‚" },
            "Claymation": { spec: "3D clay texture, fingerprints.", desc: "é»åœŸå®šæ ¼ï¼šæº«æ½¤æ‰‹å·¥è³ªæ„Ÿã€‚" },
            "Origami": { spec: "Folded paper, sharp creases.", desc: "ç´°è†©æ‘ºç´™ï¼šå¹¾ä½•å°ç¨±ç´”æ·¨æ„Ÿã€‚" },
            "Graffiti": { spec: "Street art, spray texture.", desc: "è¡—é ­å¡—é´‰ï¼šé®®è±”éƒ½å¸‚é…·æ„Ÿã€‚" },
            "Vintage Poster": { spec: "Retro, weathered paper.", desc: "å¾©å¤æµ·å ±ï¼šæ‡·èˆŠæ­²æœˆè³ªæ„Ÿã€‚" },
            "Chalkboard": { spec: "Chalk texture, black background.", desc: "æ•™å®¤é»‘æ¿ï¼šæ•™è‚²æ°›åœè¦ªåˆ‡ã€‚" },
            "Analog Film": { spec: "Film grain, vintage color.", desc: "è† æ²åº•ç‰‡ï¼šå¾©å¤é¡†ç²’æ„Ÿèˆ‡å…‰å½±ã€‚" },
            "Pop Art": { spec: "High contrast, primary colors.", desc: "æ™®æ™®è—è¡“ï¼šå¼·çƒˆé…è‰²æ™‚å°šå‰è¡›ã€‚" },
            "Da Vinci": { spec: "Sepia ink, parchment sketch.", desc: "é”æ–‡è¥¿æ‰‹ç¨¿ï¼šå¤è€ç²¾å¯†è£½åœ–ã€‚" },
            "Blueprint": { spec: "White lines on cyan grid.", desc: "å·¥ç¨‹è—åœ–ï¼šåš´è¬¹æŠ€è¡“ç¾å­¸ã€‚" },
            "Cross-section": { spec: "Cutaway view, structural.", desc: "ç§‘å­¸å‰–é¢ï¼šæ´æ‚‰å…§éƒ¨æ§‹é€ ã€‚" },
            "Wireframe": { spec: "3D mesh, tech-forward.", desc: "æ•¸ä½ç·šæ¡†ï¼šæ¥µè‡´ç§‘æŠ€èˆ‡æœªä¾†æ„Ÿã€‚" },
            "Subway Map": { spec: "Simplification, colorful lines.", desc: "åœ°åœ–è·¯ç¶²ï¼šæ¢³ç†è¤‡é›œé—œè¯ã€‚" },
            "Cyberpunk": { spec: "Neon lights, high-tech grit.", desc: "è³½åšé¾å…‹ï¼šè—ç´«è‰²èª¿æœªä¾†æ„Ÿã€‚" },
            "Steampunk": { spec: "Victorian, brass gears.", desc: "è’¸æ°£é¾å…‹ï¼šå·¥æ¥­æ©Ÿæ¢°ç¾å­¸ã€‚" },
            "Quilling": { spec: "Intricate rolled paper art.", desc: "ç´°ç·»ç´™é›•ï¼šæ²ç´™å·¥è—ç«‹é«”æ„Ÿã€‚" },
            "Flat Lay": { spec: "Top-down, arranged objects.", desc: "æ”å½±æ“ºæ‹ï¼šæ•´é½Šç™‚ç™’çš„ä¿¯è¦–ã€‚" },
            "Glassmorphism": { spec: "Frosted glass, blurred.", desc: "ç»ç’ƒæ“¬æ…‹ï¼šç¾ä»£æ™‚å°šå±¤æ¬¡ã€‚" },
            "Diorama": { spec: "Miniature scene, tilt-shift.", desc: "å¾®ç¸®æ™¯è§€ï¼šå°å°ç©å…·ä¸–ç•Œã€‚" }
        };

        const randomTopics = ["æœªä¾†åŸå¸‚çš„å‚ç›´è¾²å ´", "é‡å­é›»è…¦å…§éƒ¨æ§‹é€ ", "æ·±æµ·ç™¼å…‰ç”Ÿç‰©", "å¤ªç©ºæ®–æ°‘åœ°ç”Ÿæ…‹åœˆ", "è²“å’ªçµ±æ²»çš„åŸå¸‚"];

        // ------------------ æŒ‡ä»¤ç”Ÿæˆé‚è¼¯ ------------------
        let history = JSON.parse(localStorage.getItem('prompt_history') || '[]');
        let selectedType = 'infographic';

        function vibrate() { if (navigator.vibrate) navigator.vibrate(15); }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.className = 'nav-btn text-gray-400 flex flex-col items-center p-2';
            });
            btn.className = 'nav-btn nav-active flex flex-col items-center p-2';
        }

        function setType(type, btn) {
            selectedType = type;
            document.querySelectorAll('.type-btn').forEach(b => {
                b.className = 'type-btn border border-gray-100 dark:border-slate-700 p-3 rounded-2xl text-gray-500 dark:text-slate-400 text-xs font-medium transition-all';
            });
            btn.className = 'type-btn ring-2 ring-indigo-500 bg-indigo-50 dark:bg-indigo-900/40 p-3 rounded-2xl text-indigo-700 dark:text-indigo-300 text-xs font-bold transition-all';
        }

        // æ™ºæ…§éš¨æ©Ÿ (ä¿®å¾©å®Œæˆ)
        function randomSurprise() {
            vibrate();
            const icon = document.getElementById('diceIcon');
            icon.classList.add('rolling');
            setTimeout(() => icon.classList.remove('rolling'), 500);

            // 1. éš¨æ©Ÿé¡å‹
            const types = ['infographic', 'diagram', 'flowchart', 'timeline'];
            const randomType = types[Math.floor(Math.random() * types.length)];
            const targetBtn = document.getElementById('btn-' + randomType);
            if (targetBtn) setType(randomType, targetBtn);

            // 2. éš¨æ©Ÿä¸»é¡Œ
            document.getElementById('content').value = randomTopics[Math.floor(Math.random() * randomTopics.length)];

            // 3. éš¨æ©Ÿé¢¨æ ¼
            const styleSelect = document.getElementById('style');
            const options = Array.from(styleSelect.querySelectorAll('option')).filter(o => o.value !== "");
            if (options.length > 0) {
                styleSelect.value = options[Math.floor(Math.random() * options.length)].value;
                updatePreview();
            }
        }

        function updatePreview() {
            const style = document.getElementById('style').value;
            const card = document.getElementById('previewCard');
            if(styleSpecs[style]) {
                document.getElementById('previewText').innerText = styleSpecs[style].desc;
                card.classList.remove('hidden');
            }
        }

        function generate() {
            const content = document.getElementById('content').value.trim() || "Concept";
            const style = document.getElementById('style').value;
            if(!style) return alert('è«‹å…ˆé¸æ“‡é¢¨æ ¼');
            const negPrompt = "\nNegative: low quality, blurry, distorted text.";
            const fullPrompt = `/imagine prompt: A ${style} style ${selectedType} about '${content}'. \n- ${styleSpecs[style].spec} \n- AR 9:16${negPrompt} --v 6.0`;
            document.getElementById('finalPrompt').innerText = fullPrompt;
            document.getElementById('resultBox').classList.remove('hidden');
            saveToHistory(style, content, fullPrompt);
            renderHistory();
        }

        function saveToHistory(s, c, p) {
            history.unshift({ style: s, content: c, prompt: p });
            if (history.length > 5) history.pop();
            localStorage.setItem('prompt_history', JSON.stringify(history));
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = history.map((item, index) => `
                <div class="p-3 bg-white dark:bg-slate-900 rounded-xl border flex justify-between items-center shadow-sm" onclick="loadFromHistory(${index})">
                    <div><p class="text-[9px] font-bold text-indigo-500 uppercase">${item.style}</p>
                    <p class="text-[11px] text-gray-500 truncate w-40 font-medium">${item.content}</p></div>
                    <i class="fas fa-magic text-[10px] text-indigo-300"></i>
                </div>`).join('');
        }

        function loadFromHistory(i) {
            const item = history[i];
            document.getElementById('finalPrompt').innerText = item.prompt;
            document.getElementById('resultBox').classList.remove('hidden');
        }

        function clearHistory() { history = []; localStorage.removeItem('prompt_history'); renderHistory(); }
        function copyText() { navigator.clipboard.writeText(document.getElementById('finalPrompt').innerText); alert('å·²è¤‡è£½ï¼'); }
        function shareLine() { window.open(`https://line.me/R/msg/text/?${encodeURIComponent(document.getElementById('finalPrompt').innerText)}`); }
        function shareFB() { window.open(`https://www.facebook.com/sharer/sharer.php?u=${window.location.href}`); }

        // ------------------ åœ–åƒä¿®å¾©é‚è¼¯ ------------------
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let currentX, currentY, bgImg;

        function loadImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    bgImg = new Image();
                    bgImg.onload = () => {
                        canvas.width = bgImg.width; canvas.height = bgImg.height;
                        ctx.drawImage(bgImg, 0, 0);
                        document.getElementById('editorArea').classList.remove('hidden');
                        document.getElementById('uploadArea').classList.add('hidden');
                    };
                    bgImg.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            currentX = (e.clientX - rect.left) * (canvas.width / rect.width);
            currentY = (e.clientY - rect.top) * (canvas.height / rect.height);
            const p = ctx.getImageData(currentX, currentY, 1, 1).data;
            if (p[0] < 200) document.getElementById('textColor').value = "#" + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1);
            document.getElementById('textOverlay').classList.remove('hidden');
            document.getElementById('textOverlay').classList.add('flex');
        });

        function applyText() {
            const text = document.getElementById('correctText').value;
            const size = parseInt(document.getElementById('fontSize').value);
            const color = document.getElementById('textColor').value;
            if (!text) return;
            const bg = ctx.getImageData(currentX - size, currentY, 1, 1).data;
            ctx.fillStyle = `rgb(${bg[0]}, ${bg[1]}, ${bg[2]})`;
            ctx.fillRect(currentX - size, currentY - size, size * 2, size * 2);
            ctx.fillStyle = color;
            ctx.font = `bold ${size}px ${document.getElementById('fontFamily').value}`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(text, currentX, currentY);
            closeOverlay();
            document.getElementById('correctText').value = '';
        }

        function closeOverlay() { document.getElementById('textOverlay').classList.add('hidden'); }
        function downloadImage() { const a = document.createElement('a'); a.download = 'fixed.png'; a.href = canvas.toDataURL(); a.click(); }

        renderHistory();
    </script>
</body>
</html>
