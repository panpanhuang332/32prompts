<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI å…¨èƒ½å·¥å…·ç®± (äººç‰©ç‰¹å¾µç‰ˆ)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* --- æ ¸å¿ƒä½ˆå±€ --- */
        body { background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .app-header { background: white; padding: 15px 15px 0 15px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0; }
        
        .nav-tabs { border-bottom: none; flex-wrap: nowrap; overflow-x: auto; white-space: nowrap; gap: 5px; padding-bottom: 5px; }
        .nav-tabs .nav-link { border: none; color: #6c757d; font-size: 0.95rem; padding: 8px 12px; border-radius: 20px; background-color: #f8f9fa; transition: all 0.2s; }
        .nav-tabs .nav-link.active { color: white; background-color: #4285f4; font-weight: bold; }
        .nav-tabs .nav-link.disabled-tab { opacity: 0.5; pointer-events: none; background-color: #e9ecef; }
        
        .app-content { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: #f0f2f5; scroll-behavior: smooth; }
        .tab-content-area { display: none; animation: fadeIn 0.3s; }
        .tab-content-area.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .category-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: opacity 0.3s; }
        .category-card.disabled-card { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        .category-title { font-size: 0.9rem; font-weight: bold; color: #343a40; margin-bottom: 8px; display: block; border-left: 4px solid #4285f4; padding-left: 8px; }
        
        .app-footer { background: white; padding: 10px 15px; border-top: 1px solid #dee2e6; flex-shrink: 0; z-index: 20; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .loading-text { font-size: 0.8em; color: #4285f4; margin-top: 5px; display: none; }
        .form-select { background-color: #f8f9fa; border: 1px solid #e9ecef; }
        .locked-badge { display: none; font-size: 0.7rem; background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        .camera-preview-box {
            position: relative; width: 70px; height: 70px; background: #e9ecef; border-radius: 8px; overflow: hidden; display: none; border: 2px solid #4285f4; margin-right: 10px; flex-shrink: 0;
        }
        .captured-image { width: 100%; height: 100%; object-fit: cover; }
        .btn-clear-img { position: absolute; top: 0; right: 0; background: rgba(220, 53, 69, 0.9); color: white; border: none; width: 20px; height: 20px; font-size: 14px; line-height: 20px; text-align: center; cursor: pointer; z-index: 5; }

        .btn-random { background-color: #fbbc04; border-color: #fbbc04; color: #333; font-weight: bold; }
        
        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        .mode-switch-container { display: flex; gap: 5px; margin-bottom: 10px; background: #f1f3f4; padding: 4px; border-radius: 8px; }
        .mode-btn { flex: 1; border: none; background: transparent; padding: 8px; font-size: 0.85rem; border-radius: 6px; color: #5f6368; font-weight: bold; transition: all 0.2s; }
        .mode-btn.active { background: white; color: #1967d2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .mode-btn.mode-reverse.active { color: #8e24aa; } 
    </style>
</head>
<body>

    <div class="app-header">
        <h6 class="mb-2 fw-bold text-dark">ğŸ¨ AI å…¨èƒ½å·¥å…·ç®± (äººç‰©ç‰¹å¾µç‰ˆ)</h6>
        
        <div class="mode-switch-container">
            <button class="mode-btn active" onclick="setMode('create')" id="mode-create">âœ¨ ç¹ªåœ–æŒ‡ä»¤</button>
            <button class="mode-btn mode-reverse" onclick="setMode('reverse')" id="mode-reverse">ğŸ”® åæ¨æç¤ºè©</button>
        </div>

        <div class="mb-2">
            <div class="input-group mb-2">
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleImageSelect(this)">

                <div id="previewBox" class="camera-preview-box">
                    <img id="finalImage" class="captured-image">
                    <button class="btn-clear-img" onclick="clearPhoto()">Ã—</button>
                </div>

                <input type="text" class="form-control" id="mainSubject" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: å¥³å­©)...">
                
                <button class="btn btn-outline-danger" type="button" onclick="triggerNativeCamera()">
                    ğŸ“¸
                </button>
                
                <button class="btn btn-random" id="btnRandom" type="button" onclick="autoRandomize()">
                    ğŸ²
                </button>
            </div>
            
            <div id="translationStatus" class="loading-text">æ­£åœ¨ç¿»è­¯ä¸­...</div>
        </div>

        <div class="nav nav-tabs" id="myTab" role="tablist">
            <button class="nav-link active" onclick="switchTab(this, 'page-settings')">âš™ï¸ è¨­å®š</button>
            <button class="nav-link" onclick="switchTab(this, 'page-char')">ğŸ‘¤ äººç‰©</button>
            <button class="nav-link" onclick="switchTab(this, 'page-photo')">ğŸ“¸ æ”å½±</button>
            <button class="nav-link" id="btn-art" onclick="switchTab(this, 'page-art')">ğŸ–Œï¸ è—è¡“ <span class="locked-badge">é–å®š</span></button>
            <button class="nav-link" id="btn-anime" onclick="switchTab(this, 'page-anime')">ğŸ§¸ å‹•æ¼« <span class="locked-badge">é–å®š</span></button>
        </div>
    </div>

    <div class="app-content">
        <div id="mode-hint" class="mb-3"></div>

        <div id="page-settings" class="tab-content-area active">
            <div class="category-card">
                <label class="category-title">ğŸ“ åœ–ç‰‡æ¯”ä¾‹ (Aspect Ratio)</label>
                <select class="form-select" id="aspectRatio">
                    <option value="" selected>1:1 (é è¨­æ­£æ–¹å½¢)</option>
                    <optgroup label="æ©«å‘">
                        <option value="16:9">16:9 (å¯¬è¢å¹•/YT)</option>
                        <option value="21:9">21:9 (Notionå°é¢)</option>
                        <option value="4:3">4:3 (æ¨™æº–ç…§ç‰‡)</option>
                    </optgroup>
                    <optgroup label="ç›´å‘">
                        <option value="4:5">4:5 (IG è²¼æ–‡)</option>
                        <option value="3:4">3:4 (ç›´å¼ç…§ç‰‡)</option>
                        <option value="9:16">9:16 (é™å‹•/Reels)</option>
                    </optgroup>
                </select>
            </div>

            <div class="category-card">
                <label class="category-title">ğŸ’ è§£æåº¦ (Resolution)</label>
                <select class="form-select" id="pixelResolution">
                    <option value="" selected>é è¨­</option>
                    <optgroup label="ç¤¾ç¾¤/è¢å¹•">
                        <option value="1080x1080 px, high quality">IG æ­£æ–¹å½¢ (1080p)</option>
                        <option value="3840x2160 px, 4K UHD">4K è¶…é«˜ç•«è³ª</option>
                    </optgroup>
                    <optgroup label="å°åˆ·/æ”å½±">
                        <option value="2480x3508 px, 300DPI">A4 å°åˆ·è¦æ ¼</option>
                        <option value="6000x4000 px, 24MP">2400 è¬åƒç´ </option>
                    </optgroup>
                </select>
            </div>
        </div>

        <div id="page-char" class="tab-content-area"><div id="container-char"></div></div>
        
        <div id="page-photo" class="tab-content-area"><div id="container-photo"></div></div>
        <div id="page-art" class="tab-content-area"><div id="container-art"></div></div>
        <div id="page-anime" class="tab-content-area"><div id="container-anime"></div></div>
    </div>

    <div class="app-footer">
        <div class="d-grid gap-2 mb-2">
            <button class="btn btn-primary fw-bold" id="generateBtn" onclick="generatePrompt()" style="background-color: #4285f4; border-color: #4285f4;">
                âœ¨ ç”¢å‡ºæŒ‡ä»¤
            </button>
        </div>
        <div class="input-group input-group-sm">
            <textarea class="form-control" id="outputPrompt" rows="3" readonly placeholder="æç¤ºè©å°‡é¡¯ç¤ºæ–¼æ­¤" style="resize: none; font-size: 0.85rem;"></textarea>
            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard()">è¤‡è£½</button>
        </div>
    </div>

<script>
    let currentMode = 'create';

    // --- 0. æ¨¡å¼èˆ‡åˆ†é åˆ‡æ› ---
    function setMode(mode) {
        currentMode = mode;
        const mainSubject = document.getElementById('mainSubject');
        const btnRandom = document.getElementById('btnRandom');
        const tabs = document.getElementById('myTab');
        const hint = document.getElementById('mode-hint');
        const generateBtn = document.getElementById('generateBtn');

        document.getElementById('mode-create').classList.toggle('active', mode === 'create');
        document.getElementById('mode-reverse').classList.toggle('active', mode === 'reverse');

        if (mode === 'reverse') {
            mainSubject.style.display = 'none';
            btnRandom.style.display = 'none';
            tabs.style.display = 'none';
            switchTab(document.querySelector('.nav-link'), 'page-settings');
            hint.innerHTML = `<div style="background: #f3e5f5; padding: 10px; border-radius: 8px; color: #6a1b9a;"><strong>ğŸ”® åæ¨æç¤ºè©æ¨¡å¼</strong><br>1. æŒ‰ ğŸ“¸ æ‹ä¸‹åœ–ç‰‡ã€‚<br>2. æŒ‰ç”¢å‡ºï¼Œè¤‡è£½æŒ‡ä»¤ã€‚<br>3. åœ¨ Gemini è²¼ä¸Šæ–‡å­—ä¸¦<b>ä¸Šå‚³åœ–ç‰‡</b>ã€‚</div>`;
            generateBtn.textContent = "ğŸ” ç”¢å‡ºåˆ†ææŒ‡ä»¤";
            generateBtn.style.backgroundColor = "#8e24aa";
            generateBtn.style.borderColor = "#8e24aa";
        } else {
            mainSubject.style.display = 'block';
            btnRandom.style.display = 'block';
            tabs.style.display = 'flex';
            hint.innerHTML = "";
            generateBtn.textContent = "âœ¨ ç”¢å‡ºç¹ªåœ–æŒ‡ä»¤";
            generateBtn.style.backgroundColor = "#4285f4";
            generateBtn.style.borderColor = "#4285f4";
        }
    }

    function switchTab(btn, targetId) {
        if (btn.classList.contains('disabled-tab')) return;
        document.querySelectorAll('.nav-link').forEach(b => {
            b.classList.remove('active'); b.style.backgroundColor='#f8f9fa'; b.style.color='#6c757d';
        });
        btn.classList.add('active'); btn.style.backgroundColor='#4285f4'; btn.style.color='white';
        document.querySelectorAll('.tab-content-area').forEach(div => div.classList.remove('active'));
        document.getElementById(targetId).classList.add('active');
    }

    // --- 1. è³‡æ–™åº« (æ–°å¢äººç‰©ç‰¹å¾µ) ---
    const categorizedData = {
        "char": {
            "æœè£ç©¿æ­ (Clothing)": [
                {val: "T-shirt and jeans", label: "Tæ¤ç‰›ä»”è¤² (Casual)"},
                {val: "Suit and tie", label: "è¥¿è£é ˜å¸¶ (Formal)"},
                {val: "Evening gown", label: "æ™šç¦®æœ (Gown)"},
                {val: "Cyberpunk techwear", label: "è³½åšæ©Ÿèƒ½é¢¨ (Techwear)"},
                {val: "School uniform", label: "å­¸æ ¡åˆ¶æœ (Uniform)"},
                {val: "Kimono", label: "å’Œæœ (Kimono)"},
                {val: "Maid outfit", label: "å¥³åƒ•è£ (Maid)"},
                {val: "Sportswear", label: "é‹å‹•æœ (Sportswear)"},
                {val: "Hoodie", label: "é€£å¸½è¡« (Hoodie)"},
                {val: "Armor", label: "ç›”ç”² (Armor)"}
            ],
            "é«®å‹é«®è‰² (Hair)": [
                {val: "Long straight black hair", label: "é»‘é•·ç›´ (Long Black)"},
                {val: "Short bob cut", label: "é®‘ä¼¯é ­ (Bob cut)"},
                {val: "Blonde ponytail", label: "é‡‘é«®é¦¬å°¾ (Blonde Ponytail)"},
                {val: "Silver twin tails", label: "éŠ€é«®é›™é¦¬å°¾ (Silver Twin-tails)"},
                {val: "Messy hair", label: "å‡Œäº‚é«®å‹ (Messy)"},
                {val: "Pink hair", label: "ç²‰è‰²é ­é«® (Pink)"},
                {val: "Bald", label: "å…‰é ­ (Bald)"},
                {val: "Mohawk", label: "é¾å…‹é ­ (Mohawk)"},
                {val: "Curly hair", label: "æ²é«® (Curly)"},
                {val: "Gradient hair color", label: "æ¼¸å±¤é«®è‰² (Gradient)"}
            ],
            "äº”å®˜ç‰¹é» (Face)": [
                {val: "Blue eyes", label: "è—çœ¼ç› (Blue Eyes)"},
                {val: "Red eyes", label: "ç´…çœ¼ç› (Red Eyes)"},
                {val: "Heterochromia", label: "ç•°è‰²ç³ (Odd Eyes)"},
                {val: "Cat eyes", label: "è²“çœ¼ (Cat Eyes)"},
                {val: "Freckles", label: "é›€æ–‘ (Freckles)"},
                {val: "Scar on face", label: "è‡‰ä¸Šç–¤ç—• (Scar)"},
                {val: "Wearing glasses", label: "æˆ´çœ¼é¡ (Glasses)"},
                {val: "Wearing a mask", label: "æˆ´å£ç½© (Mask)"},
                {val: "Makeup", label: "åŒ–å¦ (Makeup)"}
            ],
            "è¡¨æƒ… (Expression)": [
                {val: "Smile", label: "å¾®ç¬‘ (Smile)"},
                {val: "Laughing", label: "å¤§ç¬‘ (Laughing)"},
                {val: "Crying", label: "å“­æ³£ (Crying)"},
                {val: "Angry", label: "ç”Ÿæ°£ (Angry)"},
                {val: "Expressionless", label: "ç„¡è¡¨æƒ… (Expressionless)"},
                {val: "Seductive smile", label: "èª˜æƒ‘ (Seductive)"},
                {val: "Surprised", label: "é©šè¨ (Surprised)"},
                {val: "Winking", label: "çœ¨çœ¼ (Winking)"},
                {val: "Tongue out", label: "åèˆŒ (Tongue out)"}
            ],
            "è‚¢é«”å‹•ä½œ (Pose)": [
                {val: "Standing", label: "ç«™ç«‹ (Standing)"},
                {val: "Sitting on a chair", label: "åè‘— (Sitting)"},
                {val: "Lying in bed", label: "èººè‘— (Lying)"},
                {val: "Running", label: "å¥”è·‘ (Running)"},
                {val: "Jumping", label: "è·³èº (Jumping)"},
                {val: "Fighting stance", label: "æˆ°é¬¥å§¿å‹¢ (Fighting)"},
                {val: "Peace sign", label: "æ¯”YA (Peace sign)"},
                {val: "Crossing arms", label: "é›™æ‰‹æŠ±èƒ¸ (Crossing arms)"},
                {val: "Looking back", label: "å›é ­çœ‹ (Looking back)"}
            ],
            "é«”å‹ (Body)": [
                {val: "Slim body", label: "è‹—æ¢ (Slim)"},
                {val: "Muscular body", label: "è‚Œè‚‰ (Muscular)"},
                {val: "Curvy body", label: "æ›²ç·š (Curvy)"},
                {val: "Chubby", label: "è‚‰æ„Ÿ (Chubby)"},
                {val: "Tall", label: "é«˜æŒ‘ (Tall)"},
                {val: "Petite", label: "å¬Œå° (Petite)"}
            ]
        },
        "photo": { 
            "æ”å½±é¡å‹": [{id:"photo_type", val:"photo", label:"ç…§ç‰‡"}, {id:"photo_type", val:"portrait", label:"äººåƒ"}, {id:"photo_type", val:"selfie", label:"è‡ªæ‹"}, {id:"photo_type", val:"full body shot", label:"å…¨èº«ç…§"}],
            "å…‰åœˆ": [{id:"photo_aperture", val:"f/1.4", label:"f/1.4"}, {id:"photo_aperture", val:"f/2.8", label:"f/2.8"}, {id:"photo_aperture", val:"f/8", label:"f/8"}],
            "ç„¦è·": [{id:"photo_focal", val:"35mm", label:"35mm"}, {id:"photo_focal", val:"85mm", label:"85mm"}, {id:"photo_focal", val:"200mm", label:"200mm"}],
            "ç’°å¢ƒ": [{val:"cinematic lighting", label:"é›»å½±å…‰"}, {val:"natural light", label:"è‡ªç„¶å…‰"}, {val:"dark", label:"æš—èª¿"}, {val:"bright", label:"æ˜äº®"}],
            "é¢¨æ ¼": [{val:"Fujifilm style", label:"å¯Œå£«åº•ç‰‡"}, {val:"Cyberpunk", label:"è³½åšé¾å…‹"}, {val:"Vintage", label:"å¾©å¤"}]
        },
        "art": { 
            "åª’æ": [{val:"illustration", label:"æ’ç•«"}, {val:"oil painting", label:"æ²¹ç•«"}, {val:"watercolor", label:"æ°´å½©"}, {val:"vector art", label:"å‘é‡åœ–"}],
            "æµæ´¾": [{val:"Impressionism", label:"å°è±¡æ´¾"}, {val:"Surrealism", label:"è¶…ç¾å¯¦"}, {val:"Ukiyo-e", label:"æµ®ä¸–ç¹ª"}]
        },
        "anime": { 
            "ä½œå“": [{val:"One Piece style", label:"èˆªæµ·ç‹"}, {val:"Studio Ghibli style", label:"å‰åœåŠ›"}, {val:"Naruto style", label:"ç«å½±å¿è€…"}, {val:"Slam Dunk style", label:"çŒç±ƒé«˜æ‰‹"}],
            "é¡å‹": [{val:"90s anime style", label:"90å¹´ä»£è³½ç’ç’"}, {val:"Makoto Shinkai style", label:"æ–°æµ·èª é¢¨æ™¯"}]
        }
    };

    function init() {
        for (const [tabKey, categories] of Object.entries(categorizedData)) {
            const container = document.getElementById(`container-${tabKey}`);
            if (!container) continue;
            for (const [catName, items] of Object.entries(categories)) {
                const card = document.createElement('div'); card.className = 'category-card';
                const label = document.createElement('label'); label.className = 'category-title'; label.textContent = catName;
                card.appendChild(label);
                const select = document.createElement('select'); select.className = 'form-select category-select';
                if (items.length > 0 && items[0].id) select.id = items[0].id;
                select.appendChild(new Option("ä¸æŒ‡å®š", ""));
                items.forEach(item => select.appendChild(new Option(item.label, item.val)));
                card.appendChild(select);
                container.appendChild(card);
            }
        }
        
        // æ’ä»–é‚è¼¯
        const photoType = document.getElementById('photo_type');
        if (photoType) {
            photoType.addEventListener('change', function() {
                const isPhoto = this.value !== "";
                ['photo_aperture', 'photo_focal'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) { el.disabled = !isPhoto; if(!isPhoto) el.value=""; }
                });
                toggleLock('container-art', 'btn-art', isPhoto);
                toggleLock('container-anime', 'btn-anime', isPhoto);
            });
        }
        ['photo_aperture', 'photo_focal'].forEach(id => { const el = document.getElementById(id); if(el) el.disabled = true; });
        
        setMode('create');
    }

    function toggleLock(cid, bid, lock) {
        const c = document.getElementById(cid), b = document.getElementById(bid);
        c.querySelectorAll('select').forEach(s => { s.disabled = lock; if(lock) s.value=""; });
        b.classList.toggle('disabled-tab', lock);
        c.querySelectorAll('.category-card').forEach(card => card.classList.toggle('disabled-card', lock));
        b.querySelector('.locked-badge').style.display = lock ? 'inline-block' : 'none';
    }

    // --- 2. éš¨æ©Ÿé‚è¼¯ ---
    function autoRandomize() {
        if (currentMode === 'reverse') return;

        let activeTabId = document.querySelector('.tab-content-area.active').id;
        let targetContainer = "";
        
        // å¦‚æœåœ¨è¨­å®šé ï¼Œé è¨­è·³è½‰åˆ°ã€Œäººç‰©ã€é é€²è¡Œéš¨æ©Ÿ (å› ç‚ºæ–°å¢äº†äººç‰©)
        if (activeTabId === 'page-settings') {
            switchTab(document.querySelectorAll('.nav-link')[1], 'page-char'); 
            targetContainer = 'container-char';
        } else {
            targetContainer = activeTabId.replace('page-', 'container-');
        }

        const container = document.getElementById(targetContainer);
        if (!container) return;

        const selects = container.querySelectorAll('select');
        let changedCount = 0;
        selects.forEach(select => {
            if (select.disabled) return;
            const options = select.options;
            if (options.length > 1) {
                const randomIndex = Math.floor(Math.random() * (options.length - 1)) + 1;
                select.selectedIndex = randomIndex;
                const event = new Event('change');
                select.dispatchEvent(event);
                changedCount++;
            }
        });

        if (changedCount > 0) {
            generatePrompt();
            const btn = document.querySelector('.btn-random');
            const originalText = btn.textContent;
            btn.textContent = "âœ…";
            setTimeout(() => btn.textContent = originalText, 1000);
        }
    }

    // --- 3. ç”¢å‡ºé‚è¼¯ ---
    async function generatePrompt() {
        const aspectRatio = document.getElementById('aspectRatio').value;
        const pixelRes = document.getElementById('pixelResolution').value;
        const hasPhoto = document.getElementById('finalImage').getAttribute('src') !== "";
        let parts = [];

        if (currentMode === 'reverse') {
            if (!hasPhoto) { alert("è«‹å…ˆæ‹ç…§ï¼"); return; }
            parts.push("You are an expert Prompt Engineer.");
            parts.push("Please analyze the attached image in extreme detail.");
            parts.push("Provide a comprehensive text prompt that could generate this exact image.");
            parts.push("Include descriptions of: 1. Subject & Appearance 2. Pose & Expression 3. Clothing & Accessories 4. Art Style & Medium.");
            parts.push("Output format: A single, high-quality descriptive paragraph in English.");
        } else {
            let mainSubject = document.getElementById('mainSubject').value.trim();
            const btn = document.getElementById('generateBtn');

            if (/[\u4e00-\u9fa5]/.test(mainSubject) && mainSubject !== "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]") {
                const originalText = btn.textContent;
                btn.textContent = "â³ ç¿»è­¯ä¸­...";
                btn.disabled = true;
                mainSubject = await translateInput() || mainSubject;
                btn.textContent = originalText;
                btn.disabled = false;
            }

            if (hasPhoto) {
                parts.push("INSTRUCTION: Analyze the attached image deeply.");
                parts.push("1. Identify the pose, composition, and main elements.");
                if (mainSubject && mainSubject !== "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]") {
                    parts.push(`2. Modification Request: Transform the subject into: ${mainSubject}.`);
                } else {
                    parts.push("2. Recreate this image maintaining the original composition.");
                }
            } else {
                parts.push("Generate an image with the following description:");
                if (mainSubject) parts.push(`Subject: ${mainSubject}.`);
            }

            let details = [];
            document.querySelectorAll('.category-select').forEach(select => {
                if (select.value && !select.disabled) details.push(select.value);
            });

            if (details.length > 0) parts.push(`Details & Style: ${details.join(', ')}.`);
            if (pixelRes) parts.push(`Quality/Resolution: ${pixelRes}.`);
            if (aspectRatio) parts.push(`Aspect Ratio: ${aspectRatio}.`);
            parts.push("Ensure the output is highly detailed and aesthetically pleasing.");
        }
        document.getElementById('outputPrompt').value = parts.join(' ');
    }

    // --- 4. è¼”åŠ© ---
    function triggerNativeCamera() { document.getElementById('cameraInput').click(); }
    function handleImageSelect(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('finalImage').src = e.target.result;
                document.getElementById('previewBox').style.display = 'block';
                if (currentMode === 'create') {
                    const subj = document.getElementById('mainSubject');
                    if (!subj.value.trim()) subj.value = "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]";
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    function clearPhoto() {
        document.getElementById('finalImage').src = "";
        document.getElementById('previewBox').style.display = 'none';
        document.getElementById('cameraInput').value = "";
        const input = document.getElementById('mainSubject');
        if (input.value === "[è«‹ Gemini åˆ†æé€™å¼µç…§ç‰‡çš„å…§å®¹]") input.value = "";
    }
    async function translateInput() {
        const text = document.getElementById('mainSubject').value.trim();
        try {
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh-TW|en`);
            const data = await res.json();
            return data.responseData?.translatedText;
        } catch (e) { return text; }
    }
    function copyToClipboard() {
        const el = document.getElementById("outputPrompt");
        el.select(); navigator.clipboard.writeText(el.value);
    }

    init();
    if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
</script>
</body>
</html>
